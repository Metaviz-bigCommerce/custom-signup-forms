import { NextResponse } from 'next/server';
import path from 'path';
import { writeFile } from 'fs/promises';
import { env } from '@/lib/env';

type FieldType = 'text' | 'email' | 'phone' | 'number' | 'textarea' | 'select' | 'radio' | 'checkbox' | 'date' | 'file' | 'url';

type FormField = {
  id: number;
  type: FieldType;
  label: string;
  placeholder: string;
  required: boolean;
  labelColor: string;
  labelSize: string;
  labelWeight: string;
  borderColor: string;
  borderWidth: string;
  borderRadius: string;
  bgColor: string;
  padding: string;
  fontSize: string;
  textColor: string;
  // Optional semantic role (supports country/state/password/etc.)
  role?: 'first_name' | 'last_name' | 'email' | 'password' | 'country' | 'state';
  // Options for select, radio, checkbox fields
  options?: Array<{ label: string; value: string }>;
  // Row grouping for 2-column layout
  rowGroup?: number | null;
};

type Theme = {
  title?: string;
  subtitle?: string;
  titleColor?: string;
  titleFontSize?: number;
  titleFontWeight?: string;
  subtitleColor?: string;
  subtitleFontSize?: number;
  subtitleFontWeight?: string;
  primaryColor?: string;
  layout?: 'split' | 'center';
  splitImageUrl?: string;
  buttonText?: string;
  buttonBg?: string;
  buttonColor?: string;
  buttonRadius?: number;
  formBackgroundColor?: string;
  pageBackgroundColor?: string;
};

/**
 * Get maximum character length for a field based on its type and role.
 * This ensures consistent validation across Form Builder, Live Preview, and embedded forms.
 * @deprecated Not currently used but kept for potential future use
 */
function _getMaxLength(field: FormField): number | null {
  // Email fields: reasonable limit for email addresses
  if (field.type === 'email' || field.role === 'email') {
    return 50;
  }
  
  // Phone/Number fields: reasonable limit for phone numbers
  if (field.type === 'phone' || field.type === 'number') {
    return 20;
  }
  
  // Name fields: reasonable limit for first/last names
  if (field.role === 'first_name' || field.role === 'last_name') {
    return 30;
  }
  
  // Textarea: more lenient for longer text
  if (field.type === 'textarea') {
    return 1000;
  }
  
  // URL fields: reasonable limit for URLs
  if (field.type === 'url') {
    return 2048;
  }
  
  // Generic text fields: reasonable default
  if (field.type === 'text') {
    return 100;
  }
  
  // Password, date, file, select, radio, checkbox don't need maxlength
  // (password has its own validation, date/file/select have different constraints)
  return null;
}

async function _fetchCountryData(): Promise<Array<{ countryName: string; countryShortCode: string; regions: Array<{ name: string; shortCode?: string }> }>> {
  try {
    const res = await fetch('https://cdn.jsdelivr.net/npm/country-region-data@3.0.0/data.json');
    const json = await res.json();
    if (Array.isArray(json)) {
      return json;
    }
  } catch (error) {
    console.error('Failed to fetch country data:', error);
  }
  // Fallback to minimal data if fetch fails
  return [
    { countryName: 'United States', countryShortCode: 'US', regions: [{ name: 'California', shortCode: 'CA' }, { name: 'New York', shortCode: 'NY' }] },
    { countryName: 'Canada', countryShortCode: 'CA', regions: [{ name: 'Ontario', shortCode: 'ON' }, { name: 'Quebec', shortCode: 'QC' }] },
    { countryName: 'United Kingdom', countryShortCode: 'GB', regions: [{ name: 'England' }, { name: 'Scotland' }, { name: 'Wales' }, { name: 'Northern Ireland' }] },
    { countryName: 'Australia', countryShortCode: 'AU', regions: [{ name: 'New South Wales', shortCode: 'NSW' }, { name: 'Victoria', shortCode: 'VIC' }] },
    { countryName: 'India', countryShortCode: 'IN', regions: [{ name: 'Maharashtra' }, { name: 'Karnataka' }] },
    { countryName: 'Pakistan', countryShortCode: 'PK', regions: [{ name: 'Punjab' }, { name: 'Sindh' }] },
  ];
}

function _toMinifiedScript(fields: FormField[], containerId: string, theme?: Theme, countryData?: Array<{ countryName: string; countryShortCode: string; regions: Array<{ name: string; shortCode?: string }> }>) {
  // Normalize theme layout - if split layout but no valid image URL, use center
  const normalizedTheme = theme ? { ...theme } : {};
  if (normalizedTheme.layout === 'split') {
    const hasValidImageUrl = normalizedTheme.splitImageUrl && normalizedTheme.splitImageUrl.trim().length > 0;
    if (!hasValidImageUrl) {
      normalizedTheme.layout = 'center';
    }
  }
  
  // Group fields by rowGroup before generating script
  const groupedFields: Array<{ fields: FormField[]; rowGroup: number | null }> = [];
  const processedIds = new Set<number>();
  
  for (let i = 0; i < fields.length; i++) {
    if (processedIds.has(fields[i].id)) continue;
    
    const field = fields[i];
    if (field.rowGroup != null) {
      const groupFields = fields.filter(f => f.rowGroup === field.rowGroup);
      groupedFields.push({ fields: groupFields, rowGroup: field.rowGroup });
      groupFields.forEach(f => processedIds.add(f.id));
    } else {
      groupedFields.push({ fields: [field], rowGroup: null });
      processedIds.add(field.id);
    }
  }

  // Properly escape JSON strings to prevent syntax errors
  const f = JSON.stringify(JSON.stringify(fields));
  const grouped = JSON.stringify(JSON.stringify(groupedFields));
  const c = JSON.stringify(JSON.stringify(containerId));
  const t = JSON.stringify(JSON.stringify(normalizedTheme));
  // Embed country data into the script
  const cr = JSON.stringify(JSON.stringify(countryData || []));
  const code = `(function(){var hasRun=false;function hideAllContent(){var d=document;var hideStyle=d.getElementById('cs-hide-all');if(!hideStyle){hideStyle=d.createElement('style');hideStyle.id='cs-hide-all';hideStyle.textContent='body>*:not(.cs-custom-page):not(#custom-signup-container):not(#custom-signup-loading):not(.cs-toast-container):not(#cs-toast-container),header,footer,nav,main:not(#custom-signup-container),.header,.footer,.navigation,.main-content,form:not(#custom-signup-container form),form[id*="account"],form[class*="account"],form[class*="signup"],form[class*="register"],.account-form,.signup-form,.register-form,.create-account-form,#account-create,#create-account,.form-account{display:none!important;visibility:hidden!important;opacity:0!important;height:0!important;overflow:hidden!important;position:absolute!important;left:-9999px!important;pointer-events:none!important}.cs-toast-container,#cs-toast-container{display:flex!important;visibility:visible!important;opacity:1!important;position:fixed!important;pointer-events:auto!important;z-index:2147483647!important}body{overflow:auto!important;margin:0!important;padding:0!important;height:100%!important}html{overflow:auto!important;height:100%!important}.cs-custom-page{display:grid!important;visibility:visible!important;opacity:1!important;position:relative!important;left:auto!important;min-height:100vh!important;width:100%!important;overflow:visible!important;pointer-events:auto!important;z-index:9999!important}';if(d.head){d.head.insertBefore(hideStyle,d.head.firstChild)}else if(d.body){d.body.insertBefore(hideStyle,d.body.firstChild)}else{d.appendChild(hideStyle)}}var allContent=d.querySelectorAll('body>*:not(.cs-custom-page):not(#custom-signup-container):not(#custom-signup-loading):not(.cs-toast-container):not(#cs-toast-container)');for(var i=0;i<allContent.length;i++){allContent[i].style.display='none';allContent[i].style.visibility='hidden';allContent[i].style.opacity='0';allContent[i].style.height='0';allContent[i].style.overflow='hidden';allContent[i].style.position='absolute';allContent[i].style.left='-9999px';allContent[i].style.pointerEvents='none'}}function run(){if(hasRun)return;var u=window.location;var p=u.pathname;var q=u.search||'';var m=/\\/login\\.php$/i.test(p)&&/(^|[?&])action=create_account(&|$)/i.test(q);console&&console.log&&console.log('custom-signup: URL check',{pathname:p,search:q,matches:m});if(!m){console&&console.log&&console.log('custom-signup: URL does not match, exiting');return}hasRun=true;try{console&&console.log&&console.log('custom-signup: Starting...');var f=JSON.parse(${f}),g=JSON.parse(${grouped}),c=JSON.parse(${c}),t=JSON.parse(${t});console&&console.log&&console.log('custom-signup: Parsed data',{fieldsCount:f.length,groupsCount:g.length,containerId:c});var pr=t.primaryColor||'#2563eb',ttl=t.title||'Create your account',sub=t.subtitle||'Please fill in the form to continue',ttlColor=t.titleColor||pr,ttlSize=(t.titleFontSize==null?22:t.titleFontSize),ttlWeight=t.titleFontWeight||'800',subColor=t.subtitleColor||pr,subSize=(t.subtitleFontSize==null?13:t.subtitleFontSize),subWeight=t.subtitleFontWeight||'400',ly=t.layout||'center',img=t.splitImageUrl||'',btnt=t.buttonText||'Create account',btnbg=(t.buttonBg&&t.primaryColor&&t.buttonBg!==t.primaryColor)?t.buttonBg:pr,btnc=t.buttonColor||'#fff',btnr=(t.buttonRadius==null?10:t.buttonRadius),formbg=t.formBackgroundColor||'#ffffff',pagebg=t.pageBackgroundColor||'#f9fafb';var d=document;hideAllContent();var b=d.body;if(!b){console&&console.log&&console.log('custom-signup: Body not ready, retrying...');hasRun=false;var retryCount=0;var maxRetries=20;var checkBody=function(){retryCount++;b=d.body;if(b){console&&console.log&&console.log('custom-signup: Body ready after',retryCount,'retries');hasRun=false;run()}else if(retryCount<maxRetries){setTimeout(checkBody,100)}else{console&&console.error&&console.error('custom-signup: Body not ready after',maxRetries,'retries')}};setTimeout(checkBody,50);return}if(!f||!Array.isArray(f)||f.length===0){console&&console.error&&console.error('custom-signup: No form fields provided',f);return}if(!g||!Array.isArray(g)||g.length===0){console&&console.error&&console.error('custom-signup: No grouped fields provided',g);return}console&&console.log&&console.log('custom-signup: Creating form with',f.length,'fields');d.documentElement.style.visibility='hidden';d.documentElement.style.opacity='0';var css=':root{--p:'+pr+'}@keyframes cs-spin{to{transform:rotate(360deg)}}@keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-8px)}100%{transform:translateY(0)}}@keyframes cs-toast-in{from{opacity:0;transform:translateX(100%)}to{opacity:1;transform:translateX(0)}}@keyframes cs-toast-out{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(100%)}}@keyframes cs-fade-in{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.cs-error{color:#ef4444;font-size:12px;margin-top:6px}.cs-input-error{border-color:#ef4444 !important;}.cs-toast-container,#cs-toast-container{position:fixed;top:16px;right:16px;z-index:2147483647;display:flex;flex-direction:column;gap:8px;max-width:448px;width:100%}.cs-toast{display:flex;align-items:flex-start;gap:12px;padding:16px;border-radius:8px;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);animation:cs-toast-in 0.3s ease-out;font-size:14px;line-height:1.5;min-width:0}.cs-toast-success{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46}.cs-toast-error{background:#fef2f2;border:1px solid #fecaca;color:#991b1b}.cs-toast-warning{background:#fffbeb;border:1px solid #fde68a;color:#92400e}.cs-toast-info{background:#eff6ff;border:1px solid #bfdbfe;color:#1e40af}.cs-toast-icon{flex-shrink:0;width:20px;height:20px;margin-top:2px}.cs-toast-message{flex:1;font-weight:500;word-break:break-word;font-size:14px;line-height:1.5}.cs-toast-close{flex-shrink:0;background:none;border:none;color:#9ca3af;cursor:pointer;padding:0;width:16px;height:16px;display:flex;align-items:center;justify-content:center;transition:color 0.2s ease}.cs-toast-close:hover{color:#4b5563}.cs-row-group{display:grid;grid-template-columns:1fr 1fr;gap:14px}@media (max-width:640px){.cs-row-group{grid-template-columns:1fr !important}}.radio-custom{appearance:none;-webkit-appearance:none;-moz-appearance:none;border:2px solid #d1d5db;border-radius:50%;background-color:white;position:relative}.radio-custom:checked{border-color:#000;background-color:#000}.radio-custom:checked::after{content:\\'\\';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:6px;height:6px;border-radius:50%;background-color:white}.checkbox-custom{appearance:none;-webkit-appearance:none;-moz-appearance:none;border:2px solid #d1d5db;border-radius:4px;background-color:white;position:relative}.checkbox-custom:checked{border-color:#000;background-color:#000}.checkbox-custom:checked::after{content:\\'✓\\';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:white;font-size:12px;font-weight:bold;line-height:1}.cs-thank-you{display:flex;flex-direction:column;align-items:center;text-align:center;padding:40px 24px;animation:cs-fade-in 0.4s ease-out}@keyframes cs-icon-scale{0%{transform:scale(0)}50%{transform:scale(1.1)}100%{transform:scale(1)}}.cs-thank-you-icon{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,#10b981 0%,#059669 100%);display:flex;align-items:center;justify-content:center;margin-bottom:24px;box-shadow:0 8px 16px -4px rgba(16,185,129,0.3),0 4px 6px -1px rgba(0,0,0,0.1);animation:cs-icon-scale 0.5s cubic-bezier(0.34,1.56,0.64,1) forwards}.cs-thank-you-title{font-size:28px;font-weight:700;color:#111827;margin:0 0 12px 0;line-height:1.2}.cs-thank-you-message{font-size:16px;color:#6b7280;margin:0 0 32px 0;line-height:1.6;max-width:420px}.cs-thank-you-btn{border:none;padding:12px 32px;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.2s ease;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06)}.cs-thank-you-btn:hover{transform:translateY(-1px);box-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05)}.cs-thank-you-btn:active{transform:translateY(0)}';var st=d.createElement('style');st.textContent=css;d.head&&d.head.appendChild(st);b.innerHTML='';b.style.background=pagebg;b.style.margin='0';b.style.padding='0';b.style.fontFamily='ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Noto Sans, Apple Color Emoji, Segoe UI Emoji';b.style.overflow='auto';b.style.height='auto';b.style.minHeight='100vh';var L=d.createElement('div');L.id='custom-signup-loading';L.style.position='fixed';L.style.inset='0';L.style.background='#ffffff';L.style.display='flex';L.style.alignItems='center';L.style.justifyContent='center';L.style.zIndex='2147483647';var S=d.createElement('div');S.style.width='40px';S.style.height='40px';S.style.border='4px solid #e5e7eb';S.style.borderTopColor='var(--p)';S.style.borderRadius='50%';S.style.animation='cs-spin 1s linear infinite';L.appendChild(S);b.appendChild(L);var toastContainer=d.createElement('div');toastContainer.id='cs-toast-container';toastContainer.className='cs-toast-container';b.appendChild(toastContainer);var toasts=[];function showToast(message,type,duration){var d=document;var b=d.body;var tc=d.getElementById('cs-toast-container');if(!tc){tc=d.createElement('div');tc.id='cs-toast-container';tc.className='cs-toast-container';if(b){b.appendChild(tc)}else{console&&console.error&&console.error('custom-signup: Cannot create toast container, body not available')}}type=type||'info';duration=duration||(type==='error'?7000:5000);var id=Math.random().toString(36).substring(2,11);var toast=d.createElement('div');toast.className='cs-toast cs-toast-'+type;var iconSvg=d.createElementNS('http://www.w3.org/2000/svg','svg');iconSvg.setAttribute('viewBox','0 0 24 24');iconSvg.setAttribute('fill','none');iconSvg.setAttribute('width','20');iconSvg.setAttribute('height','20');iconSvg.className='cs-toast-icon';var iconPath=d.createElementNS('http://www.w3.org/2000/svg','path');if(type==='success'){iconPath.setAttribute('d','M22 11.08V12a10 10 0 1 1-5.93-9.14');iconPath.setAttribute('stroke','currentColor');iconPath.setAttribute('stroke-width','2');iconPath.setAttribute('stroke-linecap','round');iconPath.setAttribute('stroke-linejoin','round');iconPath.setAttribute('fill','none');iconSvg.appendChild(iconPath);var iconPath2=d.createElementNS('http://www.w3.org/2000/svg','path');iconPath2.setAttribute('d','m9 11 3 3L22 4');iconPath2.setAttribute('stroke','currentColor');iconPath2.setAttribute('stroke-width','2');iconPath2.setAttribute('stroke-linecap','round');iconPath2.setAttribute('stroke-linejoin','round');iconSvg.appendChild(iconPath2)}else if(type==='error'){iconPath.setAttribute('d','M22 12a10 10 0 1 1-10-10');iconPath.setAttribute('stroke','currentColor');iconPath.setAttribute('stroke-width','2');iconPath.setAttribute('stroke-linecap','round');iconPath.setAttribute('stroke-linejoin','round');iconPath.setAttribute('fill','none');iconSvg.appendChild(iconPath);var iconPath2=d.createElementNS('http://www.w3.org/2000/svg','path');iconPath2.setAttribute('d','m15 9-6 6');iconPath2.setAttribute('stroke','currentColor');iconPath2.setAttribute('stroke-width','2');iconPath2.setAttribute('stroke-linecap','round');iconPath2.setAttribute('stroke-linejoin','round');iconSvg.appendChild(iconPath2);var iconPath3=d.createElementNS('http://www.w3.org/2000/svg','path');iconPath3.setAttribute('d','m9 9 6 6');iconPath3.setAttribute('stroke','currentColor');iconPath3.setAttribute('stroke-width','2');iconPath3.setAttribute('stroke-linecap','round');iconPath3.setAttribute('stroke-linejoin','round');iconSvg.appendChild(iconPath3)}else if(type==='warning'){iconPath.setAttribute('d','M12 9v4');iconPath.setAttribute('stroke','currentColor');iconPath.setAttribute('stroke-width','2');iconPath.setAttribute('stroke-linecap','round');iconPath.setAttribute('stroke-linejoin','round');iconPath.setAttribute('fill','none');iconSvg.appendChild(iconPath);var iconPath2=d.createElementNS('http://www.w3.org/2000/svg','path');iconPath2.setAttribute('d','M12 17h.01');iconPath2.setAttribute('stroke','currentColor');iconPath2.setAttribute('stroke-width','2');iconPath2.setAttribute('stroke-linecap','round');iconPath2.setAttribute('stroke-linejoin','round');iconSvg.appendChild(iconPath2);var iconPath3=d.createElementNS('http://www.w3.org/2000/svg','path');iconPath3.setAttribute('d','M22 12a10 10 0 1 1-10-10');iconPath3.setAttribute('stroke','currentColor');iconPath3.setAttribute('stroke-width','2');iconPath3.setAttribute('stroke-linecap','round');iconPath3.setAttribute('stroke-linejoin','round');iconPath3.setAttribute('fill','none');iconSvg.appendChild(iconPath3)}else{iconPath.setAttribute('d','M12 16v-4');iconPath.setAttribute('stroke','currentColor');iconPath.setAttribute('stroke-width','2');iconPath.setAttribute('stroke-linecap','round');iconPath.setAttribute('stroke-linejoin','round');iconPath.setAttribute('fill','none');iconSvg.appendChild(iconPath);var iconPath2=d.createElementNS('http://www.w3.org/2000/svg','path');iconPath2.setAttribute('d','M12 8h.01');iconPath2.setAttribute('stroke','currentColor');iconPath2.setAttribute('stroke-width','2');iconPath2.setAttribute('stroke-linecap','round');iconPath2.setAttribute('stroke-linejoin','round');iconSvg.appendChild(iconPath2);var iconPath3=d.createElementNS('http://www.w3.org/2000/svg','path');iconPath3.setAttribute('d','M22 12a10 10 0 1 1-10-10');iconPath3.setAttribute('stroke','currentColor');iconPath3.setAttribute('stroke-width','2');iconPath3.setAttribute('stroke-linecap','round');iconPath3.setAttribute('stroke-linejoin','round');iconPath3.setAttribute('fill','none');iconSvg.appendChild(iconPath3)}var msg=d.createElement('div');msg.className='cs-toast-message';msg.textContent=message;var close=d.createElement('button');close.className='cs-toast-close';close.setAttribute('aria-label','Close');close.onclick=function(){removeToast(id)};var closeSvg=d.createElementNS('http://www.w3.org/2000/svg','svg');closeSvg.setAttribute('viewBox','0 0 24 24');closeSvg.setAttribute('fill','none');closeSvg.setAttribute('width','16');closeSvg.setAttribute('height','16');closeSvg.setAttribute('stroke','currentColor');closeSvg.setAttribute('stroke-width','2');closeSvg.setAttribute('stroke-linecap','round');closeSvg.setAttribute('stroke-linejoin','round');var closePath=d.createElementNS('http://www.w3.org/2000/svg','path');closePath.setAttribute('d','m18 6-12 12');closeSvg.appendChild(closePath);var closePath2=d.createElementNS('http://www.w3.org/2000/svg','path');closePath2.setAttribute('d','m6 6 12 12');closeSvg.appendChild(closePath2);close.appendChild(closeSvg);toast.appendChild(iconSvg);toast.appendChild(msg);toast.appendChild(close);if(tc){tc.appendChild(toast);toasts.push({id:id,element:toast});if(duration>0){setTimeout(function(){removeToast(id)},duration)}}else{console&&console.error&&console.error('custom-signup: Toast container not available')}return id}function removeToast(id){for(var i=0;i<toasts.length;i++){if(toasts[i].id===id){toasts[i].element.style.animation='cs-toast-out 0.3s ease-out';setTimeout(function(){if(toasts[i].element.parentNode){toasts[i].element.parentNode.removeChild(toasts[i].element)}toasts.splice(i,1)},300);break}}}function parseErrorMessage(err){if(!err)return'An unexpected error occurred. Please try again.';var msg=err.message||err.error||String(err);if(err.code==='DUPLICATE'){return'You have already submitted a request. Please wait for approval or contact the store admin.'}if(err.code==='FILE_UPLOAD_ERROR'||/file.*upload.*fail/i.test(msg)){if(/file.*size.*exceed/i.test(msg)||/exceeds maximum/i.test(msg)){var sizeMatch=msg.match(/(\\d+)\\s*(MB|KB|GB)/i);if(sizeMatch){return'File size exceeds the maximum allowed size of '+sizeMatch[1]+' '+sizeMatch[2]+'. Please choose a smaller file.'}return'One or more files are too large. Please ensure all files are under 10MB.'}return msg.length>200?msg.substring(0,200)+'...':msg}if(err.code==='VALIDATION_ERROR'||/validation/i.test(msg)){if(/file.*size.*exceed/i.test(msg)||/exceeds maximum/i.test(msg)){var sizeMatch=msg.match(/(\\d+)\\s*(MB|KB|GB)/i);if(sizeMatch){return'File size exceeds the maximum allowed size of '+sizeMatch[1]+' '+sizeMatch[2]+'. Please choose a smaller file.'}return'One or more files are too large. Please ensure all files are under 10MB.'}if(/file.*validation/i.test(msg)){return'One or more files failed validation. Please check file types and sizes.'}if(/invalid.*email/i.test(msg)){return'Please enter a valid email address.'}if(/invalid.*json/i.test(msg)||/invalid.*data/i.test(msg)){return'Invalid form data. Please check your entries and try again.'}if(/missing.*required/i.test(msg)){return'Please fill in all required fields.'}return'Validation error: '+msg.replace(/^[^:]+:\\s*/i,'')}if(/network|fetch|connection|timeout/i.test(msg)){return'Network error. Please check your connection and try again.'}if(/not found|404/i.test(msg)){return'Service not found. Please contact support.'}if(/unauthorized|401|403/i.test(msg)){return'Access denied. Please refresh the page and try again.'}if(/server error|500|502|503/i.test(msg)){return'Server error. Please try again in a few moments.'}return msg.length>200?msg.substring(0,200)+'...':msg}function applyStyles(e,s){for(var k in s){if(s[k]!=null){var v=s[k];var px=(k==='borderWidth'||k==='borderRadius'||k==='padding'||k==='fontSize')&&(typeof v==='number'||/^[0-9]+$/.test(v));(e.style)[k]=v+(px?'px':'');}}}function addPlaceholder(sel){var o=d.createElement('option');o.textContent='Select an option';o.value='';sel.appendChild(o)}function createArrow(parent,padding){var svg=d.createElementNS('http://www.w3.org/2000/svg','svg');svg.setAttribute('viewBox','0 0 24 24');svg.setAttribute('fill','none');svg.style.position='absolute';svg.style.right=(parseInt(padding)||12)+8+'px';svg.style.top='50%';svg.style.transform='translateY(-50%)';svg.style.pointerEvents='none';svg.style.width='16px';svg.style.height='16px';var path=d.createElementNS('http://www.w3.org/2000/svg','path');path.setAttribute('d','M6 9L12 15L18 9');path.setAttribute('stroke','#6b7280');path.setAttribute('stroke-width','2.5');path.setAttribute('stroke-linecap','round');path.setAttribute('stroke-linejoin','round');svg.appendChild(path);parent.appendChild(svg)}var CR=JSON.parse(${cr});var countrySelects=[];var stateSelects=[];function fillCountries(sel){addPlaceholder(sel);for(var i=0;i<CR.length;i++){var c=CR[i];var o=d.createElement('option');o.value=c.countryShortCode;o.textContent=c.countryName;sel.appendChild(o)}}function fillStates(sel,code){while(sel.options.length>0){sel.remove(0)}addPlaceholder(sel);var ct=null;for(var i=0;i<CR.length;i++){if(CR[i].countryShortCode===code){ct=CR[i];break}}if(ct){for(var j=0;j<ct.regions.length;j++){var r=ct.regions[j];var o=d.createElement('option');o.value=r.shortCode||r.name;o.textContent=r.name;sel.appendChild(o)}}}var currentCountry='';var page=d.createElement('div');page.className='cs-custom-page';page.style.minHeight='100vh';page.style.width='100%';page.style.display='grid';page.style.gridTemplateColumns= ly==='split'?'1.1fr .9fr':'1fr';page.style.alignItems='stretch';page.style.gap='0';page.style.position='relative';page.style.zIndex='1';page.style.overflow='visible';var left=d.createElement('div');if(ly==='split'){left.style.display='flex';left.style.alignItems='center';left.style.justifyContent='center';left.style.position='relative';left.style.overflow='hidden';if(img){left.style.backgroundImage='url('+img+')';left.style.backgroundSize='cover';left.style.backgroundPosition='center';var ov=d.createElement('div');ov.style.position='absolute';ov.style.inset='0';ov.style.background='radial-gradient(1200px 600px at -10% -20%, rgba(37,99,235,.35) 0%, transparent 60%)';left.appendChild(ov);}else{left.style.background='radial-gradient(1200px 600px at -10% -20%, var(--p) 0%, transparent 60%), radial-gradient(800px 400px at 120% 120%, #22d3ee55 0%, transparent 60%)';var orb=d.createElement('div');orb.style.width='160px';orb.style.height='160px';orb.style.borderRadius='50%';orb.style.background='linear-gradient(135deg, #fff, #ffffff55)';orb.style.opacity='0.4';orb.style.animation='float 6s ease-in-out infinite';orb.style.filter='blur(4px)';left.appendChild(orb);}}var root=d.createElement('div');root.id=c;root.style.display='flex';root.style.alignItems='center';root.style.justifyContent='center';root.style.padding='48px 16px';root.style.width='100%';root.style.height='100%';root.style.position='relative';root.style.zIndex='2';var wrap=d.createElement('div');wrap.style.width='100%';wrap.style.maxWidth='520px';wrap.style.background=formbg;wrap.style.backdropFilter='saturate(180%) blur(8px)';wrap.style.border='1px solid #e5e7eb';wrap.style.borderRadius='16px';wrap.style.boxShadow='0 20px 30px -15px rgba(0,0,0,.2)';wrap.style.padding='28px';var title=d.createElement('h1');title.textContent=ttl;title.style.fontSize=String(ttlSize)+'px';title.style.fontWeight=ttlWeight;title.style.color=ttlColor;title.style.margin='0 0 6px 0';var subtitle=d.createElement('p');subtitle.textContent=sub;subtitle.style.fontSize=String(subSize)+'px';subtitle.style.fontWeight=subWeight;subtitle.style.color=subColor;subtitle.style.margin='0 0 18px 0';var form=d.createElement('form');form.style.display='grid';form.style.gap='14px';var inputs=[];function createField(field){var g=d.createElement('div');var showLabel=field.type!=='checkbox'||(field.label&&field.label.trim());var checkboxLabel=field.type==='checkbox'&&!field.label||!field.label.trim()&&field.options&&field.options.length>0?field.options[0].label:field.label;if(showLabel){var label=d.createElement('label');var labelText=d.createTextNode(checkboxLabel);label.appendChild(labelText);if(field.required){var star=d.createElement('span');star.textContent=' *';star.style.color='red';label.appendChild(star)}applyStyles(label,{color:field.labelColor,fontSize:field.labelSize,fontWeight:field.labelWeight});label.style.display='block';label.style.marginBottom='6px';label.style.cursor='pointer';label.style.wordWrap='break-word';label.style.overflowWrap='anywhere';label.style.maxWidth='100%';g.appendChild(label)}var el,container=null;switch(field.type){case 'textarea':el=d.createElement('textarea');el.rows=3;break;case 'select':container=d.createElement('div');container.style.position='relative';container.style.width='100%';el=d.createElement('select');if(field.role!=='country'&&field.role!=='state'){var ph=field.placeholder||'Select an option';var opt=d.createElement('option');opt.value='';opt.textContent=ph;el.appendChild(opt);if(field.options){for(var oi=0;oi<field.options.length;oi++){var optEl=d.createElement('option');optEl.value=field.options[oi].value;optEl.textContent=field.options[oi].label;el.appendChild(optEl)}}}el.style.appearance='none';el.style.WebkitAppearance='none';el.style.MozAppearance='none';el.style.paddingRight=(parseInt(field.padding)||12)+30+'px';createArrow(container,field.padding);break;case 'radio':el=d.createElement('div');el.style.display='flex';el.style.flexDirection='column';el.style.gap='8px';if(field.options){for(var ri=0;ri<field.options.length;ri++){var radioLabel=d.createElement('label');radioLabel.style.display='flex';radioLabel.style.alignItems='center';radioLabel.style.gap='8px';radioLabel.style.cursor='pointer';var radioInput=d.createElement('input');radioInput.type='radio';radioInput.name='radio-'+field.id;radioInput.value=field.options[ri].value;radioInput.className='radio-custom';radioInput.style.width='18px';radioInput.style.height='18px';radioInput.style.cursor='pointer';var radioSpan=d.createElement('span');radioSpan.textContent=field.options[ri].label;applyStyles(radioSpan,{fontSize:field.fontSize,color:field.textColor});radioSpan.style.wordWrap='break-word';radioSpan.style.overflowWrap='anywhere';radioSpan.style.flex='1';radioSpan.style.minWidth='0';radioLabel.appendChild(radioInput);radioLabel.appendChild(radioSpan);el.appendChild(radioLabel)}}break;case 'checkbox':el=d.createElement('div');el.style.display='flex';el.style.flexDirection='column';el.style.gap='8px';if(field.options&&field.options.length>0){for(var ci=0;ci<field.options.length;ci++){var checkLabel=d.createElement('label');checkLabel.style.display='flex';checkLabel.style.alignItems='center';checkLabel.style.gap='8px';checkLabel.style.cursor='pointer';var checkInput=d.createElement('input');checkInput.type='checkbox';checkInput.value=field.options[ci].value;checkInput.className='checkbox-custom';checkInput.style.width='18px';checkInput.style.height='18px';checkInput.style.cursor='pointer';var checkSpan=d.createElement('span');checkSpan.textContent=field.options[ci].label;applyStyles(checkSpan,{fontSize:field.fontSize,color:field.textColor});checkSpan.style.wordWrap='break-word';checkSpan.style.overflowWrap='anywhere';checkSpan.style.flex='1';checkSpan.style.minWidth='0';checkLabel.appendChild(checkInput);checkLabel.appendChild(checkSpan);el.appendChild(checkLabel)}}else if(field.label&&field.label.trim()){var singleCheck=d.createElement('label');singleCheck.style.display='flex';singleCheck.style.alignItems='center';singleCheck.style.gap='8px';singleCheck.style.cursor='pointer';var singleInput=d.createElement('input');singleInput.type='checkbox';singleInput.className='checkbox-custom';singleInput.style.width='18px';singleInput.style.height='18px';singleInput.style.cursor='pointer';var singleSpan=d.createElement('span');singleSpan.textContent=field.label;applyStyles(singleSpan,{fontSize:field.fontSize,color:field.textColor});singleSpan.style.wordWrap='break-word';singleSpan.style.overflowWrap='anywhere';singleSpan.style.flex='1';singleSpan.style.minWidth='0';singleCheck.appendChild(singleInput);singleCheck.appendChild(singleSpan);el.appendChild(singleCheck)}break;case 'file':var fileContainer=d.createElement('div');fileContainer.style.position='relative';fileContainer.style.width='100%';el=d.createElement('input');el.type='file';el.id='cs-file-'+field.id;el.accept='.pdf,.doc,.docx,.xls,.xlsx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';el.style.position='absolute';el.style.opacity='0';el.style.width='100%';el.style.height='100%';el.style.cursor='pointer';el.style.zIndex='2';var fileNameDisplay=d.createElement('div');fileNameDisplay.style.borderColor=field.borderColor||'#e5e7eb';fileNameDisplay.style.borderWidth=field.borderWidth||'1';fileNameDisplay.style.borderStyle='solid';fileNameDisplay.style.borderRadius=field.borderRadius||'10';fileNameDisplay.style.backgroundColor=field.bgColor||'#fff';fileNameDisplay.style.padding=field.padding||'12';fileNameDisplay.style.fontSize=field.fontSize||'14';fileNameDisplay.style.color='#9ca3af';fileNameDisplay.style.width='100%';fileNameDisplay.style.minHeight=(parseInt(field.padding||'12')*2+parseInt(field.fontSize||'14')+4)+'px';fileNameDisplay.style.display='flex';fileNameDisplay.style.alignItems='center';fileNameDisplay.style.cursor='pointer';fileNameDisplay.style.boxSizing='border-box';fileNameDisplay.style.pointerEvents='none';var fileNameSpan=d.createElement('span');fileNameSpan.style.overflow='hidden';fileNameSpan.style.textOverflow='ellipsis';fileNameSpan.style.whiteSpace='nowrap';fileNameSpan.style.flex='1';fileNameSpan.style.pointerEvents='none';fileNameSpan.textContent='Choose file...';fileNameDisplay.appendChild(fileNameSpan);fileContainer.appendChild(el);fileContainer.appendChild(fileNameDisplay);el.onchange=function(e){var file=e.target.files&&e.target.files[0];if(!file){var errEl=g.querySelector('.cs-error');if(errEl){errEl.textContent='';errEl.style.display='none'}fileNameDisplay.style.borderColor=field.borderColor||'#e5e7eb';fileNameSpan.textContent='Choose file...';fileNameSpan.style.color='#9ca3af';return}var fileName=file.name.split(/[/\\\\]/).pop()||file.name;fileNameSpan.textContent=fileName;fileNameSpan.style.color=field.textColor||'#0f172a';var MAX_SIZE=10*1024*1024;var ALLOWED_TYPES=['application/pdf','application/msword','application/vnd.openxmlformats-officedocument.wordprocessingml.document','application/vnd.ms-excel','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];var errEl=g.querySelector('.cs-error')||d.createElement('div');errEl.className='cs-error';if(!g.querySelector('.cs-error')){g.appendChild(errEl)}var error='';if(file.size>MAX_SIZE){error='File size exceeds 10MB limit. Current size: '+(file.size/(1024*1024)).toFixed(2)+'MB'}else if(!ALLOWED_TYPES.includes(file.type)){error='Only PDF, DOC, DOCX, XLS, and XLSX files are allowed'}if(error){errEl.textContent=error;errEl.style.display='block';errEl.style.color='#ef4444';errEl.style.fontSize='12px';errEl.style.marginTop='6px';fileNameDisplay.style.borderColor='#ef4444';el.value='';fileNameSpan.textContent='Choose file...';fileNameSpan.style.color='#9ca3af'}else{errEl.textContent='';errEl.style.display='none';fileNameDisplay.style.borderColor=field.borderColor||'#e5e7eb'}};fileNameDisplay.onclick=function(e){e.preventDefault();el.click()};fileNameDisplay.setAttribute('role','button');fileNameDisplay.setAttribute('tabIndex','0');fileNameDisplay.setAttribute('aria-label',(field.label||'File upload')+' - Click to select file');fileNameDisplay.onkeydown=function(e){if(e.key==='Enter'||e.key===' '){e.preventDefault();el.click()}};el.setAttribute('aria-label',field.label||'File upload');el=fileContainer;break;default:el=d.createElement('input');el.type=(field.type==='phone'?'tel':(field.role==='password'?'password':field.type));if(field.type==='phone'){el.pattern='[0-9]*';el.inputMode='numeric';el.onkeypress=function(e){if(!/[0-9]/.test(e.key)&&!['Backspace','Delete','Tab','Enter'].includes(e.key)){e.preventDefault()}}}}if(field.role==='country'){if(!(el&&el.tagName==='SELECT')){container=d.createElement('div');container.style.position='relative';container.style.width='100%';el=d.createElement('select')}var countryPlaceholder=field.placeholder||'Select a country';fillCountries(el,countryPlaceholder);el.addEventListener('change',function(){currentCountry=el.value;for(var si=0;si<stateSelects.length;si++){var stateField=stateSelects[si].field;var statePlaceholder=stateField&&stateField.placeholder?stateField.placeholder:'Select a state/province';fillStates(stateSelects[si].el,currentCountry,statePlaceholder)}});countrySelects.push(el);el.style.appearance='none';el.style.WebkitAppearance='none';el.style.MozAppearance='none';el.style.paddingRight=(parseInt(field.padding)||12)+30+'px';if(container){createArrow(container,field.padding)}else{var countryContainer=d.createElement('div');countryContainer.style.position='relative';countryContainer.style.width='100%';countryContainer.appendChild(el);createArrow(countryContainer,field.padding);el=countryContainer}}else if(field.role==='state'){if(!(el&&el.tagName==='SELECT')){container=d.createElement('div');container.style.position='relative';container.style.width='100%';el=d.createElement('select')}var statePlaceholder=field.placeholder||'Select a state/province';fillStates(el,currentCountry,statePlaceholder);stateSelects.push({el:el,field:field});el.style.appearance='none';el.style.WebkitAppearance='none';el.style.MozAppearance='none';el.style.paddingRight=(parseInt(field.padding)||12)+30+'px';if(container){createArrow(container,field.padding)}else{var stateContainer=d.createElement('div');stateContainer.style.position='relative';stateContainer.style.width='100%';stateContainer.appendChild(el);createArrow(stateContainer,field.padding);el=stateContainer}}if(el&&el.tagName!=='DIV'&&field.type!=='radio'&&field.type!=='checkbox'){el.placeholder=field.placeholder||'';applyStyles(el,{borderColor:field.borderColor||'#e5e7eb',borderWidth:field.borderWidth||'1',borderStyle:'solid',borderRadius:field.borderRadius||'10',backgroundColor:field.bgColor||'#fff',padding:field.padding||'12',fontSize:field.fontSize||'14',color:field.textColor||'#0f172a'});el.style.width='100%';el.style.outline='none';el.setAttribute('aria-label',field.label);var maxLen=field.type==='email'||field.role==='email'?50:field.type==='phone'||field.type==='number'?20:field.role==='first_name'||field.role==='last_name'?30:field.type==='textarea'?1000:field.type==='url'?2048:field.type==='text'?100:null;if(maxLen!==null&&field.type!=='select'&&field.type!=='file'&&field.type!=='date'){el.setAttribute('maxlength',maxLen)}}if(container){container.appendChild(el);g.appendChild(container)}else{g.appendChild(el)}var err=d.createElement('div');err.className='cs-error';err.style.display='none';g.appendChild(err);var inputEl=el;if(container){inputEl=el.querySelector('select')||el}if(field.type==='radio'||field.type==='checkbox'){var allInputs=el.querySelectorAll('input');inputs.push({cfg:field,el:allInputs,err:err})}else{inputs.push({cfg:field,el:inputEl,err:err})}return g}for(var gi=0;gi<g.length;gi++){var group=g[gi];if(group.rowGroup!=null&&group.fields.length===2){var rowGroup=d.createElement('div');rowGroup.className='cs-row-group';for(var fi=0;fi<group.fields.length;fi++){var fieldEl=createField(group.fields[fi]);rowGroup.appendChild(fieldEl)}form.appendChild(rowGroup)}else{for(var fi=0;fi<group.fields.length;fi++){var fieldEl=createField(group.fields[fi]);form.appendChild(fieldEl)}}}var btn=d.createElement('button');btn.type='submit';btn.textContent=btnt;btn.style.height='46px';btn.style.border='0';btn.style.borderRadius=String(btnr)+'px';btn.style.background=btnbg;btn.style.color=btnc;btn.style.fontWeight='700';btn.style.letterSpacing='.02em';btn.style.cursor='pointer';btn.style.marginTop='8px';btn.style.transition='transform .12s ease, opacity .12s ease';btn.onmousedown=function(){btn.style.transform='scale(0.98)'};btn.onmouseup=function(){btn.style.transform='scale(1)'};form.appendChild(btn);function vEmail(x){return /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(String(x||'').toLowerCase())}function vUrl(x){try{return Boolean(new URL(String(x||'')))}catch(e){return false}}function vPhone(x){return /^[0-9\\-+()\\s]{7,}$/.test(String(x||''))}function vPwd(x){return /^(?=.*[A-Za-z])(?=.*\\d).{7,}$/.test(String(x||''))}function vZip(x){return /^[A-Za-z0-9 \\-]{3,12}$/.test(String(x||''))}function getVal(cfg,el){if(cfg.type==='checkbox'||cfg.type==='radio'){if(el.length){for(var vi=0;vi<el.length;vi++){if(el[vi].checked)return el[vi].value}return''}return el.checked?el.value:''}return (el.value||'').trim()}function setErr(it,msg){it.err.textContent=msg||'';it.err.style.display=msg?'block':'none';if(msg){if(it.el.length){for(var ei=0;ei<it.el.length;ei++){it.el[ei].classList.add('cs-input-error')}}else{it.el.classList.add('cs-input-error')}}else{if(it.el.length){for(var ei=0;ei<it.el.length;ei++){it.el[ei].classList.remove('cs-input-error')}}else{it.el.classList.remove('cs-input-error')}}}function validate(){var ok=true;for(var j=0;j<inputs.length;j++){var it=inputs[j];var cfg=it.cfg;var el=it.el;var val=getVal(cfg,el);var lbl=(cfg.label||'').toLowerCase();setErr(it,'');if(cfg.required&&(!val&&val!==false)){setErr(it,'This field is required');ok=false;continue}if(val){switch(cfg.type){case 'email':if(!vEmail(val)){setErr(it,'Enter a valid email');ok=false}break;case 'url':if(!vUrl(val)){setErr(it,'Enter a valid URL');ok=false}break;case 'number':if(isNaN(Number(val))){setErr(it,'Enter a valid number');ok=false}break;case 'phone':if(!vPhone(val)){setErr(it,'Enter a valid phone');ok=false}break;}if(/password/i.test(lbl)){if(!vPwd(val)){setErr(it,'Password must be 7+ chars and include letters and numbers');ok=false}}else if(cfg.type!=='phone'&&/(phone|mobile|contact)/i.test(lbl)){if(!vPhone(val)){setErr(it,'Enter a valid phone');ok=false}}else if(/(zip|postal)/i.test(lbl)){if(!vZip(val)){setErr(it,'Enter a valid postal code');ok=false}}}}return ok}function collect(){var obj={};for(var j=0;j<inputs.length;j++){var it=inputs[j];var cfg=it.cfg;var key=cfg.label||('Field '+(j+1));var val=getVal(cfg,it.el);obj[key]=val}return obj}function getEmail(){for(var j=0;j<inputs.length;j++){if(inputs[j].cfg&&inputs[j].cfg.type==='email'){var v=getVal(inputs[j].cfg,inputs[j].el);if(vEmail(v))return v.toLowerCase()}}var data=collect();for(var k in data){if(/email/i.test(k)){var vv=String(data[k]||'');if(vEmail(vv))return vv.toLowerCase()}}return ''}function hasFiles(){for(var j=0;j<inputs.length;j++){if(inputs[j].cfg&&inputs[j].cfg.type==='file'){var f=inputs[j].el.files;if(f&&f.length>0)return true}}return false}function appendFiles(fd){for(var j=0;j<inputs.length;j++){if(inputs[j].cfg&&inputs[j].cfg.type==='file'){var fl=inputs[j].el.files||[];if(fl.length){var label=encodeURIComponent(inputs[j].cfg.label||('File '+(j+1)));for(var k=0;k<fl.length;k++){fd.append('file__'+label,fl[k])}}}}}function showThankYouPage(){var d=document;var wrapEl=wrap;if(!wrapEl)return;wrapEl.innerHTML='';wrapEl.style.display='flex';wrapEl.style.flexDirection='column';wrapEl.style.alignItems='center';wrapEl.style.textAlign='center';wrapEl.style.padding='48px 32px';var thankYouDiv=d.createElement('div');thankYouDiv.className='cs-thank-you';var iconDiv=d.createElement('div');iconDiv.className='cs-thank-you-icon';var iconSvg=d.createElementNS('http://www.w3.org/2000/svg','svg');iconSvg.setAttribute('viewBox','0 0 24 24');iconSvg.setAttribute('fill','none');iconSvg.setAttribute('width','44');iconSvg.setAttribute('height','44');var outerCircle=d.createElementNS('http://www.w3.org/2000/svg','circle');outerCircle.setAttribute('cx','12');outerCircle.setAttribute('cy','12');outerCircle.setAttribute('r','11');outerCircle.setAttribute('fill','white');outerCircle.setAttribute('opacity','0.25');iconSvg.appendChild(outerCircle);var innerCircle=d.createElementNS('http://www.w3.org/2000/svg','circle');innerCircle.setAttribute('cx','12');innerCircle.setAttribute('cy','12');innerCircle.setAttribute('r','9');innerCircle.setAttribute('fill','white');iconSvg.appendChild(innerCircle);var checkPath=d.createElementNS('http://www.w3.org/2000/svg','path');checkPath.setAttribute('d','M9 12l2 2 4-4');checkPath.setAttribute('stroke','#10b981');checkPath.setAttribute('stroke-width','3');checkPath.setAttribute('stroke-linecap','round');checkPath.setAttribute('stroke-linejoin','round');checkPath.setAttribute('fill','none');iconSvg.appendChild(checkPath);iconDiv.appendChild(iconSvg);var titleEl=d.createElement('h2');titleEl.className='cs-thank-you-title';titleEl.textContent='Thank You!';var messageEl=d.createElement('p');messageEl.className='cs-thank-you-message';messageEl.textContent='Your request has been successfully submitted and is now under review. Please wait for approval. You will receive an email notification once your request has been processed.';var btnEl=d.createElement('button');btnEl.className='cs-thank-you-btn';btnEl.style.background=btnbg;btnEl.style.color=btnc;btnEl.style.borderRadius=String(btnr)+'px';btnEl.textContent='Continue Shopping';btnEl.onclick=function(){window.location.href='/'};btnEl.onmousedown=function(){btnEl.style.transform='scale(0.98)'};btnEl.onmouseup=function(){btnEl.style.transform='scale(1)'};thankYouDiv.appendChild(iconDiv);thankYouDiv.appendChild(titleEl);thankYouDiv.appendChild(messageEl);thankYouDiv.appendChild(btnEl);wrapEl.appendChild(thankYouDiv)}form.addEventListener('submit',function(e){e.preventDefault();if(!validate()){for(var j=0;j<inputs.length;j++){if(inputs[j].err.style.display==='block'){try{if(inputs[j].el.length){inputs[j].el[0].focus()}else{inputs[j].el.focus()}}catch(_){}break}}return}var s=d.currentScript||d.querySelector('script[src*="custom-signup.min.js"]')||null;var src=s&&s.src||'';var base;var pub='';try{var us=new URL(src,window.location.origin);base=us.origin;pub=us.searchParams.get('pub')||''}catch(_){base=window.location.origin}if(!base){base='';}btn.disabled=true;var prev=btn.textContent;btn.textContent='Submitting…';var dataObj=collect();var email=getEmail();if(hasFiles()){var fd=new FormData();fd.append('pub',pub);fd.append('email',email);fd.append('data',JSON.stringify(dataObj));appendFiles(fd);fetch(base+'/api/public/signup-requests?pub='+encodeURIComponent(pub),{method:'POST',body:fd}).then(function(res){return res.json().then(function(j){if(!res.ok)throw j;return j})}).then(function(){showThankYouPage()}).catch(function(err){var msg=parseErrorMessage(err);showToast(msg,'error');btn.textContent=prev;btn.disabled=false})}else{var payload={data:dataObj,pub:pub,email:email};fetch(base+'/api/public/signup-requests?pub='+encodeURIComponent(pub),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}).then(function(res){return res.json().then(function(j){if(!res.ok)throw j;return j})}).then(function(){showThankYouPage()}).catch(function(err){var msg=parseErrorMessage(err);showToast(msg,'error');btn.textContent=prev;btn.disabled=false})}});wrap.appendChild(title);wrap.appendChild(subtitle);wrap.appendChild(form);root.appendChild(wrap);if(ly==='split'){page.appendChild(left);}page.appendChild(root);console&&console.log&&console.log('custom-signup: Form created, appending to body');var L=d.getElementById('custom-signup-loading');if(L&&L.parentNode){L.parentNode.removeChild(L)}if(!page.parentNode){b.appendChild(page);console&&console.log&&console.log('custom-signup: Page appended to body')}else{console&&console.log&&console.log('custom-signup: Page already in body')}hideAllContent();page.style.display='grid';page.style.visibility='visible';page.style.opacity='1';page.style.width='100%';page.style.height='100vh';console&&console.log&&console.log('custom-signup: Form should be visible now');setTimeout(function(){d.documentElement.style.visibility='visible';d.documentElement.style.opacity='1';if(page){page.style.opacity='1';page.style.visibility='visible';page.style.display='grid';console&&console.log&&console.log('custom-signup: Document made visible')}},50);var observer=new MutationObserver(function(){hideAllContent();var existingContent=d.querySelectorAll('body>*:not(.cs-custom-page):not(#custom-signup-container):not(#custom-signup-loading):not(.cs-toast-container):not(#cs-toast-container)');for(var i=0;i<existingContent.length;i++){if(existingContent[i]!==page&&existingContent[i]!==toastContainer){existingContent[i].style.display='none';existingContent[i].style.visibility='hidden';existingContent[i].style.opacity='0';existingContent[i].style.height='0';existingContent[i].style.overflow='hidden';existingContent[i].style.position='absolute';existingContent[i].style.left='-9999px';existingContent[i].style.pointerEvents='none'}}});if(b){observer.observe(b,{childList:true,subtree:true})}setTimeout(function(){observer.disconnect()},15000);}catch(e){hasRun=false;try{var d=document;var L=d.getElementById('custom-signup-loading');if(L&&L.parentNode){L.parentNode.removeChild(L)}d.documentElement.style.visibility='visible';d.documentElement.style.opacity='1';console&&console.error&&console.error('custom-signup error:',e.message||e,e.stack||'')}catch(_){};console&&console.error&&console.error('custom-signup error',e);}}function init(){if(document.body){run()}else{setTimeout(init,10)}}if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',function(){console&&console.log&&console.log('custom-signup: DOMContentLoaded fired');run()},{once:true});window.addEventListener('load',function(){console&&console.log&&console.log('custom-signup: Window load fired');run()},{once:true});setTimeout(function(){console&&console.log&&console.log('custom-signup: Timeout 1 (50ms)');run()},50);setTimeout(function(){console&&console.log&&console.log('custom-signup: Timeout 2 (200ms)');run()},200);setTimeout(function(){console&&console.log&&console.log('custom-signup: Timeout 3 (500ms)');run()},500);setTimeout(function(){console&&console.log&&console.log('custom-signup: Timeout 4 (1000ms)');run()},1000);init()}else{console&&console.log&&console.log('custom-signup: Document already ready, running immediately');run();setTimeout(function(){console&&console.log&&console.log('custom-signup: Delayed run 1');run()},50);setTimeout(function(){console&&console.log&&console.log('custom-signup: Delayed run 2');run()},200)}})();`;
  return code;
}

/**
 * Generates a generic script that fetches form configuration dynamically
 * The script no longer embeds form data - it fetches it from the API at runtime
 */
function generateGenericScript(apiBaseUrl: string): string {
  // This generates the complete generic script (~60K characters) that:
  // 1. Immediately hides default form (synchronously)
  // 2. Shows loading spinner
  // 3. Extracts pub from script URL
  // 4. Fetches /api/public/form-config?pub={pub}
  // 5. Groups fields and normalizes theme (client-side)
  // 6. Calls renderForm(config) with all rendering logic
  // 7. On error: restores default form, logs errors
  
  const apiBase = JSON.stringify(apiBaseUrl || '');
  return `(function(){var hasRun=false;var API_BASE=${apiBase};function hideAllContent(){var d=document;var hideStyle=d.getElementById('cs-hide-all');if(!hideStyle){hideStyle=d.createElement('style');hideStyle.id='cs-hide-all';hideStyle.textContent='body>*:not(.cs-custom-page):not(#custom-signup-container):not(#custom-signup-loading):not(.cs-toast-container):not(#cs-toast-container),header,footer,nav,main:not(#custom-signup-container),.header,.footer,.navigation,.main-content,form:not(#custom-signup-container form),form[id*="account"],form[class*="account"],form[class*="signup"],form[class*="register"],.account-form,.signup-form,.register-form,.create-account-form,#account-create,#create-account,.form-account{display:none!important;visibility:hidden!important;opacity:0!important;height:0!important;overflow:hidden!important;position:absolute!important;left:-9999px!important;pointer-events:none!important}.cs-toast-container,#cs-toast-container{display:flex!important;visibility:visible!important;opacity:1!important;position:fixed!important;pointer-events:auto!important;z-index:2147483647!important}body{overflow:auto!important;margin:0!important;padding:0!important;height:100%!important}html{overflow:auto!important;height:100%!important}.cs-custom-page{display:grid!important;visibility:visible!important;opacity:1!important;position:relative!important;left:auto!important;min-height:100vh!important;width:100%!important;overflow:visible!important;pointer-events:auto!important;z-index:9999!important}';if(d.head){d.head.insertBefore(hideStyle,d.head.firstChild)}else if(d.body){d.body.insertBefore(hideStyle,d.body.firstChild)}else{d.appendChild(hideStyle)}}var allContent=d.querySelectorAll('body>*:not(.cs-custom-page):not(#custom-signup-container):not(#custom-signup-loading):not(.cs-toast-container):not(#cs-toast-container)');for(var i=0;i<allContent.length;i++){allContent[i].style.display='none';allContent[i].style.visibility='hidden';allContent[i].style.opacity='0';allContent[i].style.height='0';allContent[i].style.overflow='hidden';allContent[i].style.position='absolute';allContent[i].style.left='-9999px';allContent[i].style.pointerEvents='none'}}function restoreDefaultForm(){var d=document;var hideStyle=d.getElementById('cs-hide-all');if(hideStyle&&hideStyle.parentNode){hideStyle.parentNode.removeChild(hideStyle)}var loading=d.getElementById('custom-signup-loading');if(loading&&loading.parentNode){loading.parentNode.removeChild(loading)}var page=d.querySelector('.cs-custom-page');if(page&&page.parentNode){page.parentNode.removeChild(page)}var toastContainer=d.getElementById('cs-toast-container');if(toastContainer&&toastContainer.parentNode){toastContainer.parentNode.removeChild(toastContainer)}d.documentElement.style.visibility='';d.documentElement.style.opacity='';var allContent=d.querySelectorAll('body>*');for(var i=0;i<allContent.length;i++){allContent[i].style.display='';allContent[i].style.visibility='';allContent[i].style.opacity='';allContent[i].style.height='';allContent[i].style.overflow='';allContent[i].style.position='';allContent[i].style.left='';allContent[i].style.pointerEvents=''}console&&console.log&&console.log('custom-signup: Default form restored')}function showLoadingSpinner(){var d=document;var b=d.body;if(!b)return null;var L=d.getElementById('custom-signup-loading');if(L)return L;L=d.createElement('div');L.id='custom-signup-loading';L.style.position='fixed';L.style.inset='0';L.style.background='#ffffff';L.style.display='flex';L.style.alignItems='center';L.style.justifyContent='center';L.style.zIndex='2147483647';var S=d.createElement('div');S.style.width='40px';S.style.height='40px';S.style.border='4px solid #e5e7eb';S.style.borderTopColor='#2563eb';S.style.borderRadius='50%';S.style.animation='cs-spin 1s linear infinite';var spinStyle=d.createElement('style');spinStyle.textContent='@keyframes cs-spin{to{transform:rotate(360deg)}}';if(d.head){d.head.appendChild(spinStyle)}L.appendChild(S);b.appendChild(L);return L}var toasts=[];function showToast(message,type,duration){var d=document;var b=d.body;var tc=d.getElementById('cs-toast-container');if(!tc){tc=d.createElement('div');tc.id='cs-toast-container';tc.className='cs-toast-container';if(b){b.appendChild(tc)}else{console&&console.error&&console.error('custom-signup: Cannot create toast container, body not available')}}type=type||'info';duration=duration||(type==='error'?7000:5000);var id=Math.random().toString(36).substring(2,11);var toast=d.createElement('div');toast.className='cs-toast cs-toast-'+type;var iconSvg=d.createElementNS('http://www.w3.org/2000/svg','svg');iconSvg.setAttribute('viewBox','0 0 24 24');iconSvg.setAttribute('fill','none');iconSvg.setAttribute('width','20');iconSvg.setAttribute('height','20');iconSvg.className='cs-toast-icon';var iconPath=d.createElementNS('http://www.w3.org/2000/svg','path');if(type==='success'){iconPath.setAttribute('d','M22 11.08V12a10 10 0 1 1-5.93-9.14');iconPath.setAttribute('stroke','currentColor');iconPath.setAttribute('stroke-width','2');iconPath.setAttribute('stroke-linecap','round');iconPath.setAttribute('stroke-linejoin','round');iconPath.setAttribute('fill','none');iconSvg.appendChild(iconPath);var iconPath2=d.createElementNS('http://www.w3.org/2000/svg','path');iconPath2.setAttribute('d','m9 11 3 3L22 4');iconPath2.setAttribute('stroke','currentColor');iconPath2.setAttribute('stroke-width','2');iconPath2.setAttribute('stroke-linecap','round');iconPath2.setAttribute('stroke-linejoin','round');iconSvg.appendChild(iconPath2)}else if(type==='error'){iconPath.setAttribute('d','M22 12a10 10 0 1 1-10-10');iconPath.setAttribute('stroke','currentColor');iconPath.setAttribute('stroke-width','2');iconPath.setAttribute('stroke-linecap','round');iconPath.setAttribute('stroke-linejoin','round');iconPath.setAttribute('fill','none');iconSvg.appendChild(iconPath);var iconPath2=d.createElementNS('http://www.w3.org/2000/svg','path');iconPath2.setAttribute('d','m15 9-6 6');iconPath2.setAttribute('stroke','currentColor');iconPath2.setAttribute('stroke-width','2');iconPath2.setAttribute('stroke-linecap','round');iconPath2.setAttribute('stroke-linejoin','round');iconSvg.appendChild(iconPath2);var iconPath3=d.createElementNS('http://www.w3.org/2000/svg','path');iconPath3.setAttribute('d','m9 9 6 6');iconPath3.setAttribute('stroke','currentColor');iconPath3.setAttribute('stroke-width','2');iconPath3.setAttribute('stroke-linecap','round');iconPath3.setAttribute('stroke-linejoin','round');iconSvg.appendChild(iconPath3)}else if(type==='warning'){iconPath.setAttribute('d','M12 9v4');iconPath.setAttribute('stroke','currentColor');iconPath.setAttribute('stroke-width','2');iconPath.setAttribute('stroke-linecap','round');iconPath.setAttribute('stroke-linejoin','round');iconPath.setAttribute('fill','none');iconSvg.appendChild(iconPath);var iconPath2=d.createElementNS('http://www.w3.org/2000/svg','path');iconPath2.setAttribute('d','M12 17h.01');iconPath2.setAttribute('stroke','currentColor');iconPath2.setAttribute('stroke-width','2');iconPath2.setAttribute('stroke-linecap','round');iconPath2.setAttribute('stroke-linejoin','round');iconSvg.appendChild(iconPath2);var iconPath3=d.createElementNS('http://www.w3.org/2000/svg','path');iconPath3.setAttribute('d','M22 12a10 10 0 1 1-10-10');iconPath3.setAttribute('stroke','currentColor');iconPath3.setAttribute('stroke-width','2');iconPath3.setAttribute('stroke-linecap','round');iconPath3.setAttribute('stroke-linejoin','round');iconPath3.setAttribute('fill','none');iconSvg.appendChild(iconPath3)}else{iconPath.setAttribute('d','M12 16v-4');iconPath.setAttribute('stroke','currentColor');iconPath.setAttribute('stroke-width','2');iconPath.setAttribute('stroke-linecap','round');iconPath.setAttribute('stroke-linejoin','round');iconPath.setAttribute('fill','none');iconSvg.appendChild(iconPath);var iconPath2=d.createElementNS('http://www.w3.org/2000/svg','path');iconPath2.setAttribute('d','M12 8h.01');iconPath2.setAttribute('stroke','currentColor');iconPath2.setAttribute('stroke-width','2');iconPath2.setAttribute('stroke-linecap','round');iconPath2.setAttribute('stroke-linejoin','round');iconSvg.appendChild(iconPath2);var iconPath3=d.createElementNS('http://www.w3.org/2000/svg','path');iconPath3.setAttribute('d','M22 12a10 10 0 1 1-10-10');iconPath3.setAttribute('stroke','currentColor');iconPath3.setAttribute('stroke-width','2');iconPath3.setAttribute('stroke-linecap','round');iconPath3.setAttribute('stroke-linejoin','round');iconPath3.setAttribute('fill','none');iconSvg.appendChild(iconPath3)}var msg=d.createElement('div');msg.className='cs-toast-message';msg.textContent=message;var close=d.createElement('button');close.className='cs-toast-close';close.setAttribute('aria-label','Close');close.onclick=function(){removeToast(id)};var closeSvg=d.createElementNS('http://www.w3.org/2000/svg','svg');closeSvg.setAttribute('viewBox','0 0 24 24');closeSvg.setAttribute('fill','none');closeSvg.setAttribute('width','16');closeSvg.setAttribute('height','16');closeSvg.setAttribute('stroke','currentColor');closeSvg.setAttribute('stroke-width','2');closeSvg.setAttribute('stroke-linecap','round');closeSvg.setAttribute('stroke-linejoin','round');var closePath=d.createElementNS('http://www.w3.org/2000/svg','path');closePath.setAttribute('d','m18 6-12 12');closeSvg.appendChild(closePath);var closePath2=d.createElementNS('http://www.w3.org/2000/svg','path');closePath2.setAttribute('d','m6 6 12 12');closeSvg.appendChild(closePath2);close.appendChild(closeSvg);toast.appendChild(iconSvg);toast.appendChild(msg);toast.appendChild(close);if(tc){tc.appendChild(toast);toasts.push({id:id,element:toast});if(duration>0){setTimeout(function(){removeToast(id)},duration)}}else{console&&console.error&&console.error('custom-signup: Toast container not available')}return id}function removeToast(id){for(var i=0;i<toasts.length;i++){if(toasts[i].id===id){toasts[i].element.style.animation='cs-toast-out 0.3s ease-out';setTimeout(function(){if(toasts[i].element.parentNode){toasts[i].element.parentNode.removeChild(toasts[i].element)}toasts.splice(i,1)},300);break}}}function parseErrorMessage(err){if(!err)return'An unexpected error occurred. Please try again.';var msg=err.message||err.error||String(err);if(err.code==='DUPLICATE'){return'You have already submitted a request. Please wait for approval or contact the store admin.'}if(err.code==='FILE_UPLOAD_ERROR'||/file.*upload.*fail/i.test(msg)){if(/file.*size.*exceed/i.test(msg)||/exceeds maximum/i.test(msg)){var sizeMatch=msg.match(/(\\d+)\\s*(MB|KB|GB)/i);if(sizeMatch){return'File size exceeds the maximum allowed size of '+sizeMatch[1]+' '+sizeMatch[2]+'. Please choose a smaller file.'}return'One or more files are too large. Please ensure all files are under 10MB.'}return msg.length>200?msg.substring(0,200)+'...':msg}if(err.code==='VALIDATION_ERROR'||/validation/i.test(msg)){if(/file.*size.*exceed/i.test(msg)||/exceeds maximum/i.test(msg)){var sizeMatch=msg.match(/(\\d+)\\s*(MB|KB|GB)/i);if(sizeMatch){return'File size exceeds the maximum allowed size of '+sizeMatch[1]+' '+sizeMatch[2]+'. Please choose a smaller file.'}return'One or more files are too large. Please ensure all files are under 10MB.'}if(/file.*validation/i.test(msg)){return'One or more files failed validation. Please check file types and sizes.'}if(/invalid.*email/i.test(msg)){return'Please enter a valid email address.'}if(/invalid.*json/i.test(msg)||/invalid.*data/i.test(msg)){return'Invalid form data. Please check your entries and try again.'}if(/missing.*required/i.test(msg)){return'Please fill in all required fields.'}return'Validation error: '+msg.replace(/^[^:]+:\\s*/i,'')}if(/network|fetch|connection|timeout/i.test(msg)){return'Network error. Please check your connection and try again.'}if(/not found|404/i.test(msg)){return'Service not found. Please contact support.'}if(/unauthorized|401|403/i.test(msg)){return'Access denied. Please refresh the page and try again.'}if(/server error|500|502|503/i.test(msg)){return'Server error. Please try again in a few moments.'}return msg.length>200?msg.substring(0,200)+'...':msg}function applyStyles(e,s){for(var k in s){if(s[k]!=null){var v=s[k];var px=(k==='borderWidth'||k==='borderRadius'||k==='padding'||k==='fontSize')&&(typeof v==='number'||/^[0-9]+$/.test(v));(e.style)[k]=v+(px?'px':'');}}}function addPlaceholder(sel,placeholderText){var o=document.createElement('option');o.textContent=placeholderText||'Select an option';o.value='';sel.appendChild(o)}function createArrow(parent,padding){var svg=document.createElementNS('http://www.w3.org/2000/svg','svg');svg.setAttribute('viewBox','0 0 24 24');svg.setAttribute('fill','none');svg.style.position='absolute';svg.style.right=(parseInt(padding)||12)+8+'px';svg.style.top='50%';svg.style.transform='translateY(-50%)';svg.style.pointerEvents='none';svg.style.width='16px';svg.style.height='16px';var path=document.createElementNS('http://www.w3.org/2000/svg','path');path.setAttribute('d','M6 9L12 15L18 9');path.setAttribute('stroke','#6b7280');path.setAttribute('stroke-width','2.5');path.setAttribute('stroke-linecap','round');path.setAttribute('stroke-linejoin','round');svg.appendChild(path);parent.appendChild(svg)}function renderForm(config){var d=document;var b=d.body;if(!b){console&&console.error&&console.error('custom-signup: Body not ready');return}var fields=config.fields||[];var theme=config.theme||{};var containerId=config.containerId||'custom-signup-container';var CR=config.countryData||[];if(!fields||!Array.isArray(fields)||fields.length===0){console&&console.error&&console.error('custom-signup: No form fields provided');return}var normalizedTheme={};for(var tk in theme){normalizedTheme[tk]=theme[tk]}if(normalizedTheme.layout==='split'){var hasValidImageUrl=normalizedTheme.splitImageUrl&&normalizedTheme.splitImageUrl.trim().length>0;if(!hasValidImageUrl){normalizedTheme.layout='center'}}var groupedFields=[];var processedIds=new Set();for(var i=0;i<fields.length;i++){if(processedIds.has(fields[i].id))continue;var field=fields[i];if(field.rowGroup!=null){var groupFields=fields.filter(function(f){return f.rowGroup===field.rowGroup});groupedFields.push({fields:groupFields,rowGroup:field.rowGroup});groupFields.forEach(function(f){processedIds.add(f.id)})}else{groupedFields.push({fields:[field],rowGroup:null});processedIds.add(field.id)}}var pr=normalizedTheme.primaryColor||'#2563eb',ttl=normalizedTheme.title||'Create your account',sub=normalizedTheme.subtitle||'Please fill in the form to continue',ttlColor=normalizedTheme.titleColor||pr,ttlSize=(normalizedTheme.titleFontSize==null?22:normalizedTheme.titleFontSize),ttlWeight=normalizedTheme.titleFontWeight||'800',subColor=normalizedTheme.subtitleColor||pr,subSize=(normalizedTheme.subtitleFontSize==null?13:normalizedTheme.subtitleFontSize),subWeight=normalizedTheme.subtitleFontWeight||'400',ly=normalizedTheme.layout||'center',img=normalizedTheme.splitImageUrl||'',btnt=normalizedTheme.buttonText||'Create account',btnbg=(normalizedTheme.buttonBg&&normalizedTheme.primaryColor&&normalizedTheme.buttonBg!==normalizedTheme.primaryColor)?normalizedTheme.buttonBg:pr,btnc=normalizedTheme.buttonColor||'#fff',btnr=(normalizedTheme.buttonRadius==null?10:normalizedTheme.buttonRadius),pagebg=normalizedTheme.pageBackgroundColor||'#f9fafb';var formbg=normalizedTheme.formBackgroundColor;if(!formbg){formbg=null}d.documentElement.style.visibility='hidden';d.documentElement.style.opacity='0';var css=':root{--p:'+pr+'}@keyframes cs-spin{to{transform:rotate(360deg)}}@keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-8px)}100%{transform:translateY(0)}}@keyframes cs-toast-in{from{opacity:0;transform:translateX(100%)}to{opacity:1;transform:translateX(0)}}@keyframes cs-toast-out{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(100%)}}@keyframes cs-fade-in{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.cs-error{color:#ef4444;font-size:12px;margin-top:6px}.cs-input-error{border-color:#ef4444 !important;}.cs-toast-container,#cs-toast-container{position:fixed;top:16px;right:16px;z-index:2147483647;display:flex;flex-direction:column;gap:8px;max-width:448px;width:100%}.cs-toast{display:flex;align-items:flex-start;gap:12px;padding:16px;border-radius:8px;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);animation:cs-toast-in 0.3s ease-out;font-size:14px;line-height:1.5;min-width:0}.cs-toast-success{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46}.cs-toast-error{background:#fef2f2;border:1px solid #fecaca;color:#991b1b}.cs-toast-warning{background:#fffbeb;border:1px solid #fde68a;color:#92400e}.cs-toast-info{background:#eff6ff;border:1px solid #bfdbfe;color:#1e40af}.cs-toast-icon{flex-shrink:0;width:20px;height:20px;margin-top:2px}.cs-toast-message{flex:1;font-weight:500;word-break:break-word;font-size:14px;line-height:1.5}.cs-toast-close{flex-shrink:0;background:none;border:none;color:#9ca3af;cursor:pointer;padding:0;width:16px;height:16px;display:flex;align-items:center;justify-content:center;transition:color 0.2s ease}.cs-toast-close:hover{color:#4b5563}.cs-row-group{display:grid;grid-template-columns:1fr 1fr;gap:14px}@media (max-width:640px){.cs-row-group{grid-template-columns:1fr !important}}.radio-custom{appearance:none;-webkit-appearance:none;-moz-appearance:none;border:2px solid #d1d5db;border-radius:50%;background-color:white;position:relative}.radio-custom:checked{border-color:#000;background-color:#000}.radio-custom:checked::after{content:\\'\\';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:6px;height:6px;border-radius:50%;background-color:white}.checkbox-custom{appearance:none;-webkit-appearance:none;-moz-appearance:none;border:2px solid #d1d5db;border-radius:4px;background-color:white;position:relative}.checkbox-custom:checked{border-color:#000;background-color:#000}.checkbox-custom:checked::after{content:\\'✓\\';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:white;font-size:12px;font-weight:bold;line-height:1}.cs-thank-you{display:flex;flex-direction:column;align-items:center;text-align:center;padding:40px 24px;animation:cs-fade-in 0.4s ease-out}@keyframes cs-icon-scale{0%{transform:scale(0)}50%{transform:scale(1.1)}100%{transform:scale(1)}}.cs-thank-you-icon{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,#10b981 0%,#059669 100%);display:flex;align-items:center;justify-content:center;margin-bottom:24px;box-shadow:0 8px 16px -4px rgba(16,185,129,0.3),0 4px 6px -1px rgba(0,0,0,0.1);animation:cs-icon-scale 0.5s cubic-bezier(0.34,1.56,0.64,1) forwards}.cs-thank-you-title{font-size:28px;font-weight:700;color:#111827;margin:0 0 12px 0;line-height:1.2}.cs-thank-you-message{font-size:16px;color:#6b7280;margin:0 0 32px 0;line-height:1.6;max-width:420px}.cs-thank-you-btn{border:none;padding:12px 32px;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.2s ease;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06)}.cs-thank-you-btn:hover{transform:translateY(-1px);box-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05)}.cs-thank-you-btn:active{transform:translateY(0)}';var st=d.createElement('style');st.textContent=css;d.head&&d.head.appendChild(st);b.innerHTML='';b.style.background=pagebg;b.style.margin='0';b.style.padding='0';b.style.fontFamily='ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Noto Sans, Apple Color Emoji, Segoe UI Emoji';b.style.overflow='auto';b.style.height='auto';b.style.minHeight='100vh';var L=d.getElementById('custom-signup-loading');if(L&&L.parentNode){L.parentNode.removeChild(L)}var toastContainer=d.createElement('div');toastContainer.id='cs-toast-container';toastContainer.className='cs-toast-container';b.appendChild(toastContainer);var countrySelects=[];var stateSelects=[];function fillCountries(sel,placeholderText){addPlaceholder(sel,placeholderText);for(var i=0;i<CR.length;i++){var c=CR[i];var o=d.createElement('option');o.value=c.countryShortCode;o.textContent=c.countryName;sel.appendChild(o)}}function fillStates(sel,code,placeholderText){while(sel.options.length>0){sel.remove(0)}addPlaceholder(sel,placeholderText);var ct=null;for(var i=0;i<CR.length;i++){if(CR[i].countryShortCode===code){ct=CR[i];break}}if(ct){for(var j=0;j<ct.regions.length;j++){var r=ct.regions[j];var o=d.createElement('option');o.value=r.shortCode||r.name;o.textContent=r.name;sel.appendChild(o)}}}var currentCountry='';var page=d.createElement('div');page.className='cs-custom-page';page.style.minHeight='100vh';page.style.width='100%';page.style.display='grid';page.style.gridTemplateColumns=ly==='split'?'1.1fr .9fr':'1fr';page.style.alignItems='stretch';page.style.gap='0';page.style.position='relative';page.style.zIndex='1';page.style.overflow='visible';var left=d.createElement('div');if(ly==='split'){left.style.display='flex';left.style.alignItems='center';left.style.justifyContent='center';left.style.position='relative';left.style.overflow='hidden';if(img){left.style.backgroundImage='url('+img+')';left.style.backgroundSize='cover';left.style.backgroundPosition='center';var ov=d.createElement('div');ov.style.position='absolute';ov.style.inset='0';ov.style.background='radial-gradient(1200px 600px at -10% -20%, rgba(37,99,235,.35) 0%, transparent 60%)';left.appendChild(ov);}else{left.style.background='radial-gradient(1200px 600px at -10% -20%, var(--p) 0%, transparent 60%), radial-gradient(800px 400px at 120% 120%, #22d3ee55 0%, transparent 60%)';var orb=d.createElement('div');orb.style.width='160px';orb.style.height='160px';orb.style.borderRadius='50%';orb.style.background='linear-gradient(135deg, #fff, #ffffff55)';orb.style.opacity='0.4';orb.style.animation='float 6s ease-in-out infinite';orb.style.filter='blur(4px)';left.appendChild(orb);}}var root=d.createElement('div');root.id=containerId;root.style.display='flex';root.style.alignItems='center';root.style.justifyContent='center';root.style.padding='48px 16px';root.style.width='100%';root.style.height='100%';root.style.position='relative';root.style.zIndex='2';var wrap=d.createElement('div');wrap.style.width='100%';wrap.style.maxWidth='520px';if(formbg){wrap.style.background=formbg}else{wrap.style.background='transparent'}wrap.style.backdropFilter='saturate(180%) blur(8px)';wrap.style.border='1px solid #e5e7eb';wrap.style.borderRadius='16px';wrap.style.boxShadow='0 20px 30px -15px rgba(0,0,0,.2)';wrap.style.padding='28px';var title=d.createElement('h1');title.textContent=ttl;title.style.fontSize=String(ttlSize)+'px';title.style.fontWeight=ttlWeight;title.style.color=ttlColor;title.style.margin='0 0 6px 0';var subtitle=d.createElement('p');subtitle.textContent=sub;subtitle.style.fontSize=String(subSize)+'px';subtitle.style.fontWeight=subWeight;subtitle.style.color=subColor;subtitle.style.margin='0 0 18px 0';var form=d.createElement('form');form.style.display='grid';form.style.gap='14px';var inputs=[];function createField(field){var g=d.createElement('div');var showLabel=field.type!=='checkbox'||(field.label&&field.label.trim());var checkboxLabel=field.type==='checkbox'&&!field.label||!field.label.trim()&&field.options&&field.options.length>0?field.options[0].label:field.label;if(showLabel){var label=d.createElement('label');var labelText=d.createTextNode(checkboxLabel);label.appendChild(labelText);if(field.required){var star=d.createElement('span');star.textContent=' *';star.style.color='red';label.appendChild(star)}applyStyles(label,{color:field.labelColor,fontSize:field.labelSize,fontWeight:field.labelWeight});label.style.display='block';label.style.marginBottom='6px';label.style.cursor='pointer';label.style.wordWrap='break-word';label.style.overflowWrap='anywhere';label.style.maxWidth='100%';g.appendChild(label)}var el,container=null;switch(field.type){case 'textarea':el=d.createElement('textarea');el.rows=3;break;case 'select':container=d.createElement('div');container.style.position='relative';container.style.width='100%';el=d.createElement('select');if(field.role!=='country'&&field.role!=='state'){var ph=field.placeholder||'Select an option';var opt=d.createElement('option');opt.value='';opt.textContent=ph;el.appendChild(opt);if(field.options){for(var oi=0;oi<field.options.length;oi++){var optEl=d.createElement('option');optEl.value=field.options[oi].value;optEl.textContent=field.options[oi].label;el.appendChild(optEl)}}}el.style.appearance='none';el.style.WebkitAppearance='none';el.style.MozAppearance='none';el.style.paddingRight=(parseInt(field.padding)||12)+30+'px';createArrow(container,field.padding);break;case 'radio':el=d.createElement('div');el.style.display='flex';el.style.flexDirection='column';el.style.gap='8px';if(field.options){for(var ri=0;ri<field.options.length;ri++){var radioLabel=d.createElement('label');radioLabel.style.display='flex';radioLabel.style.alignItems='center';radioLabel.style.gap='8px';radioLabel.style.cursor='pointer';var radioInput=d.createElement('input');radioInput.type='radio';radioInput.name='radio-'+field.id;radioInput.value=field.options[ri].value;radioInput.className='radio-custom';radioInput.style.width='18px';radioInput.style.height='18px';radioInput.style.cursor='pointer';var radioSpan=d.createElement('span');radioSpan.textContent=field.options[ri].label;applyStyles(radioSpan,{fontSize:field.fontSize,color:field.textColor});radioSpan.style.wordWrap='break-word';radioSpan.style.overflowWrap='anywhere';radioSpan.style.flex='1';radioSpan.style.minWidth='0';radioLabel.appendChild(radioInput);radioLabel.appendChild(radioSpan);el.appendChild(radioLabel)}}break;case 'checkbox':el=d.createElement('div');el.style.display='flex';el.style.flexDirection='column';el.style.gap='8px';if(field.options&&field.options.length>0){for(var ci=0;ci<field.options.length;ci++){var checkLabel=d.createElement('label');checkLabel.style.display='flex';checkLabel.style.alignItems='center';checkLabel.style.gap='8px';checkLabel.style.cursor='pointer';var checkInput=d.createElement('input');checkInput.type='checkbox';checkInput.value=field.options[ci].value;checkInput.className='checkbox-custom';checkInput.style.width='18px';checkInput.style.height='18px';checkInput.style.cursor='pointer';var checkSpan=d.createElement('span');checkSpan.textContent=field.options[ci].label;applyStyles(checkSpan,{fontSize:field.fontSize,color:field.textColor});checkSpan.style.wordWrap='break-word';checkSpan.style.overflowWrap='anywhere';checkSpan.style.flex='1';checkSpan.style.minWidth='0';checkLabel.appendChild(checkInput);checkLabel.appendChild(checkSpan);el.appendChild(checkLabel)}}else if(field.label&&field.label.trim()){var singleCheck=d.createElement('label');singleCheck.style.display='flex';singleCheck.style.alignItems='center';singleCheck.style.gap='8px';singleCheck.style.cursor='pointer';var singleInput=d.createElement('input');singleInput.type='checkbox';singleInput.className='checkbox-custom';singleInput.style.width='18px';singleInput.style.height='18px';singleInput.style.cursor='pointer';var singleSpan=d.createElement('span');singleSpan.textContent=field.label;applyStyles(singleSpan,{fontSize:field.fontSize,color:field.textColor});singleSpan.style.wordWrap='break-word';singleSpan.style.overflowWrap='anywhere';singleSpan.style.flex='1';singleSpan.style.minWidth='0';singleCheck.appendChild(singleInput);singleCheck.appendChild(singleSpan);el.appendChild(singleCheck)}break;case 'file':var fileContainer=d.createElement('div');fileContainer.style.position='relative';fileContainer.style.width='100%';el=d.createElement('input');el.type='file';el.id='cs-file-'+field.id;el.accept='.pdf,.doc,.docx,.xls,.xlsx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';el.style.position='absolute';el.style.opacity='0';el.style.width='100%';el.style.height='100%';el.style.cursor='pointer';el.style.zIndex='2';var fileNameDisplay=d.createElement('div');fileNameDisplay.style.borderColor=field.borderColor||'#e5e7eb';fileNameDisplay.style.borderWidth=field.borderWidth||'1';fileNameDisplay.style.borderStyle='solid';fileNameDisplay.style.borderRadius=field.borderRadius||'10';fileNameDisplay.style.backgroundColor=field.bgColor||'#fff';fileNameDisplay.style.padding=field.padding||'12';fileNameDisplay.style.fontSize=field.fontSize||'14';fileNameDisplay.style.color='#9ca3af';fileNameDisplay.style.width='100%';fileNameDisplay.style.minHeight=(parseInt(field.padding||'12')*2+parseInt(field.fontSize||'14')+4)+'px';fileNameDisplay.style.display='flex';fileNameDisplay.style.alignItems='center';fileNameDisplay.style.cursor='pointer';fileNameDisplay.style.boxSizing='border-box';fileNameDisplay.style.pointerEvents='none';var fileNameSpan=d.createElement('span');fileNameSpan.style.overflow='hidden';fileNameSpan.style.textOverflow='ellipsis';fileNameSpan.style.whiteSpace='nowrap';fileNameSpan.style.flex='1';fileNameSpan.style.pointerEvents='none';fileNameSpan.textContent='Choose file...';fileNameDisplay.appendChild(fileNameSpan);fileContainer.appendChild(el);fileContainer.appendChild(fileNameDisplay);el.onchange=function(e){var file=e.target.files&&e.target.files[0];if(!file){var errEl=g.querySelector('.cs-error');if(errEl){errEl.textContent='';errEl.style.display='none'}fileNameDisplay.style.borderColor=field.borderColor||'#e5e7eb';fileNameSpan.textContent='Choose file...';fileNameSpan.style.color='#9ca3af';return}var fileName=file.name.split(/[/\\\\]/).pop()||file.name;fileNameSpan.textContent=fileName;fileNameSpan.style.color=field.textColor||'#0f172a';var MAX_SIZE=10*1024*1024;var ALLOWED_TYPES=['application/pdf','application/msword','application/vnd.openxmlformats-officedocument.wordprocessingml.document','application/vnd.ms-excel','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];var errEl=g.querySelector('.cs-error')||d.createElement('div');errEl.className='cs-error';if(!g.querySelector('.cs-error')){g.appendChild(errEl)}var error='';if(file.size>MAX_SIZE){error='File size exceeds 10MB limit. Current size: '+(file.size/(1024*1024)).toFixed(2)+'MB'}else if(!ALLOWED_TYPES.includes(file.type)){error='Only PDF, DOC, DOCX, XLS, and XLSX files are allowed'}if(error){errEl.textContent=error;errEl.style.display='block';errEl.style.color='#ef4444';errEl.style.fontSize='12px';errEl.style.marginTop='6px';fileNameDisplay.style.borderColor='#ef4444';el.value='';fileNameSpan.textContent='Choose file...';fileNameSpan.style.color='#9ca3af'}else{errEl.textContent='';errEl.style.display='none';fileNameDisplay.style.borderColor=field.borderColor||'#e5e7eb'}};fileNameDisplay.onclick=function(e){e.preventDefault();el.click()};fileNameDisplay.setAttribute('role','button');fileNameDisplay.setAttribute('tabIndex','0');fileNameDisplay.setAttribute('aria-label',(field.label||'File upload')+' - Click to select file');fileNameDisplay.onkeydown=function(e){if(e.key==='Enter'||e.key===' '){e.preventDefault();el.click()}};el.setAttribute('aria-label',field.label||'File upload');el=fileContainer;break;default:el=d.createElement('input');el.type=(field.type==='phone'?'tel':(field.role==='password'?'password':field.type));if(field.type==='phone'){el.pattern='[0-9]*';el.inputMode='numeric';el.onkeypress=function(e){if(!/[0-9]/.test(e.key)&&!['Backspace','Delete','Tab','Enter'].includes(e.key)){e.preventDefault()}}}}if(field.role==='country'){if(!(el&&el.tagName==='SELECT')){container=d.createElement('div');container.style.position='relative';container.style.width='100%';el=d.createElement('select')}var countryPlaceholder=field.placeholder||'Select a country';fillCountries(el,countryPlaceholder);el.addEventListener('change',function(){currentCountry=el.value;for(var si=0;si<stateSelects.length;si++){var stateField=stateSelects[si].field;var statePlaceholder=stateField&&stateField.placeholder?stateField.placeholder:'Select a state/province';fillStates(stateSelects[si].el,currentCountry,statePlaceholder)}});countrySelects.push(el);el.style.appearance='none';el.style.WebkitAppearance='none';el.style.MozAppearance='none';el.style.paddingRight=(parseInt(field.padding)||12)+30+'px';if(container){createArrow(container,field.padding)}else{var countryContainer=d.createElement('div');countryContainer.style.position='relative';countryContainer.style.width='100%';countryContainer.appendChild(el);createArrow(countryContainer,field.padding);el=countryContainer}}else if(field.role==='state'){if(!(el&&el.tagName==='SELECT')){container=d.createElement('div');container.style.position='relative';container.style.width='100%';el=d.createElement('select')}var statePlaceholder=field.placeholder||'Select a state/province';fillStates(el,currentCountry,statePlaceholder);stateSelects.push({el:el,field:field});el.style.appearance='none';el.style.WebkitAppearance='none';el.style.MozAppearance='none';el.style.paddingRight=(parseInt(field.padding)||12)+30+'px';if(container){createArrow(container,field.padding)}else{var stateContainer=d.createElement('div');stateContainer.style.position='relative';stateContainer.style.width='100%';stateContainer.appendChild(el);createArrow(stateContainer,field.padding);el=stateContainer}}if(el&&el.tagName!=='DIV'&&field.type!=='radio'&&field.type!=='checkbox'){el.placeholder=field.placeholder||'';applyStyles(el,{borderColor:field.borderColor||'#e5e7eb',borderWidth:field.borderWidth||'1',borderStyle:'solid',borderRadius:field.borderRadius||'10',backgroundColor:field.bgColor||'#fff',padding:field.padding||'12',fontSize:field.fontSize||'14',color:field.textColor||'#0f172a'});el.style.width='100%';el.style.outline='none';el.setAttribute('aria-label',field.label);var maxLen=field.type==='email'||field.role==='email'?50:field.type==='phone'||field.type==='number'?20:field.role==='first_name'||field.role==='last_name'?30:field.type==='textarea'?1000:field.type==='url'?2048:field.type==='text'?100:null;if(maxLen!==null&&field.type!=='select'&&field.type!=='file'&&field.type!=='date'){el.setAttribute('maxlength',maxLen)}}if(container){container.appendChild(el);g.appendChild(container)}else{g.appendChild(el)}var err=d.createElement('div');err.className='cs-error';err.style.display='none';g.appendChild(err);var inputEl=el;if(container){inputEl=el.querySelector('select')||el}if(field.type==='radio'||field.type==='checkbox'){var allInputs=el.querySelectorAll('input');inputs.push({cfg:field,el:allInputs,err:err})}else{inputs.push({cfg:field,el:inputEl,err:err})}return g}for(var gi=0;gi<groupedFields.length;gi++){var group=groupedFields[gi];if(group.rowGroup!=null&&group.fields.length===2){var rowGroup=d.createElement('div');rowGroup.className='cs-row-group';for(var fi=0;fi<group.fields.length;fi++){var fieldEl=createField(group.fields[fi]);rowGroup.appendChild(fieldEl)}form.appendChild(rowGroup)}else{for(var fi=0;fi<group.fields.length;fi++){var fieldEl=createField(group.fields[fi]);form.appendChild(fieldEl)}}}var btn=d.createElement('button');btn.type='submit';btn.textContent=btnt;btn.style.height='46px';btn.style.border='0';btn.style.borderRadius=String(btnr)+'px';btn.style.background=btnbg;btn.style.color=btnc;btn.style.fontWeight='700';btn.style.letterSpacing='.02em';btn.style.cursor='pointer';btn.style.marginTop='8px';btn.style.transition='transform .12s ease, opacity .12s ease';btn.onmousedown=function(){btn.style.transform='scale(0.98)'};btn.onmouseup=function(){btn.style.transform='scale(1)'};form.appendChild(btn);var loginPrompt=d.createElement('div');loginPrompt.style.textAlign='center';loginPrompt.style.marginTop='16px';loginPrompt.style.fontSize='14px';loginPrompt.style.color='#6b7280';loginPrompt.style.lineHeight='1.5';var loginText=d.createTextNode('Already have an account? ');var loginLink=d.createElement('a');loginLink.href=window.location.origin+'/login.php';loginLink.textContent='Log in';loginLink.style.color=pr;loginLink.style.textDecoration='none';loginLink.style.fontWeight='500';loginLink.style.cursor='pointer';loginLink.onmouseenter=function(){loginLink.style.textDecoration='underline'};loginLink.onmouseleave=function(){loginLink.style.textDecoration='none'};loginPrompt.appendChild(loginText);loginPrompt.appendChild(loginLink);form.appendChild(loginPrompt);function vEmail(x){return /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(String(x||'').toLowerCase())}function vUrl(x){try{return Boolean(new URL(String(x||'')))}catch(e){return false}}function vPhone(x){return /^[0-9\\-+()\\s]{7,}$/.test(String(x||''))}function vPwd(x){return /^(?=.*[A-Za-z])(?=.*\\d).{7,}$/.test(String(x||''))}function vZip(x){return /^[A-Za-z0-9 \\-]{3,12}$/.test(String(x||''))}function getVal(cfg,el){if(cfg.type==='checkbox'||cfg.type==='radio'){if(el.length){for(var vi=0;vi<el.length;vi++){if(el[vi].checked)return el[vi].value}return''}return el.checked?el.value:''}return (el.value||'').trim()}function setErr(it,msg){it.err.textContent=msg||'';it.err.style.display=msg?'block':'none';if(msg){if(it.el.length){for(var ei=0;ei<it.el.length;ei++){it.el[ei].classList.add('cs-input-error')}}else{it.el.classList.add('cs-input-error')}}else{if(it.el.length){for(var ei=0;ei<it.el.length;ei++){it.el[ei].classList.remove('cs-input-error')}}else{it.el.classList.remove('cs-input-error')}}}function validate(){var ok=true;for(var j=0;j<inputs.length;j++){var it=inputs[j];var cfg=it.cfg;var el=it.el;var val=getVal(cfg,el);var lbl=(cfg.label||'').toLowerCase();setErr(it,'');if(cfg.required&&(!val&&val!==false)){setErr(it,'This field is required');ok=false;continue}if(val){switch(cfg.type){case 'email':if(!vEmail(val)){setErr(it,'Enter a valid email');ok=false}break;case 'url':if(!vUrl(val)){setErr(it,'Enter a valid URL');ok=false}break;case 'number':if(isNaN(Number(val))){setErr(it,'Enter a valid number');ok=false}break;case 'phone':if(!vPhone(val)){setErr(it,'Enter a valid phone');ok=false}break;}if(/password/i.test(lbl)){if(!vPwd(val)){setErr(it,'Password must be 7+ chars and include letters and numbers');ok=false}}else if(cfg.type!=='phone'&&/(phone|mobile|contact)/i.test(lbl)){if(!vPhone(val)){setErr(it,'Enter a valid phone');ok=false}}else if(/(zip|postal)/i.test(lbl)){if(!vZip(val)){setErr(it,'Enter a valid postal code');ok=false}}}}return ok}function collect(){var obj={};for(var j=0;j<inputs.length;j++){var it=inputs[j];var cfg=it.cfg;var key=cfg.label||('Field '+(j+1));var val=getVal(cfg,it.el);obj[key]=val}return obj}function getEmail(){for(var j=0;j<inputs.length;j++){if(inputs[j].cfg&&inputs[j].cfg.type==='email'){var v=getVal(inputs[j].cfg,inputs[j].el);if(vEmail(v))return v.toLowerCase()}}var data=collect();for(var k in data){if(/email/i.test(k)){var vv=String(data[k]||'');if(vEmail(vv))return vv.toLowerCase()}}return ''}function hasFiles(){for(var j=0;j<inputs.length;j++){if(inputs[j].cfg&&inputs[j].cfg.type==='file'){var f=inputs[j].el.files;if(f&&f.length>0)return true}}return false}function appendFiles(fd){for(var j=0;j<inputs.length;j++){if(inputs[j].cfg&&inputs[j].cfg.type==='file'){var fl=inputs[j].el.files||[];if(fl.length){var label=encodeURIComponent(inputs[j].cfg.label||('File '+(j+1)));for(var k=0;k<fl.length;k++){fd.append('file__'+label,fl[k])}}}}}function showThankYouPage(){var wrapEl=wrap;if(!wrapEl)return;wrapEl.innerHTML='';wrapEl.style.display='flex';wrapEl.style.flexDirection='column';wrapEl.style.alignItems='center';wrapEl.style.textAlign='center';wrapEl.style.padding='48px 32px';var thankYouDiv=d.createElement('div');thankYouDiv.className='cs-thank-you';var iconDiv=d.createElement('div');iconDiv.className='cs-thank-you-icon';var iconSvg=d.createElementNS('http://www.w3.org/2000/svg','svg');iconSvg.setAttribute('viewBox','0 0 24 24');iconSvg.setAttribute('fill','none');iconSvg.setAttribute('width','44');iconSvg.setAttribute('height','44');var outerCircle=d.createElementNS('http://www.w3.org/2000/svg','circle');outerCircle.setAttribute('cx','12');outerCircle.setAttribute('cy','12');outerCircle.setAttribute('r','11');outerCircle.setAttribute('fill','white');outerCircle.setAttribute('opacity','0.25');iconSvg.appendChild(outerCircle);var innerCircle=d.createElementNS('http://www.w3.org/2000/svg','circle');innerCircle.setAttribute('cx','12');innerCircle.setAttribute('cy','12');innerCircle.setAttribute('r','9');innerCircle.setAttribute('fill','white');iconSvg.appendChild(innerCircle);var checkPath=d.createElementNS('http://www.w3.org/2000/svg','path');checkPath.setAttribute('d','M9 12l2 2 4-4');checkPath.setAttribute('stroke','#10b981');checkPath.setAttribute('stroke-width','3');checkPath.setAttribute('stroke-linecap','round');checkPath.setAttribute('stroke-linejoin','round');checkPath.setAttribute('fill','none');iconSvg.appendChild(checkPath);iconDiv.appendChild(iconSvg);var titleEl=d.createElement('h2');titleEl.className='cs-thank-you-title';titleEl.textContent='Thank You!';var messageEl=d.createElement('p');messageEl.className='cs-thank-you-message';messageEl.textContent='Your request has been successfully submitted and is now under review. Please wait for approval. You will receive an email notification once your request has been processed.';var btnEl=d.createElement('button');btnEl.className='cs-thank-you-btn';btnEl.style.background=btnbg;btnEl.style.color=btnc;btnEl.style.borderRadius=String(btnr)+'px';btnEl.textContent='Continue Shopping';btnEl.onclick=function(){window.location.href='/'};btnEl.onmousedown=function(){btnEl.style.transform='scale(0.98)'};btnEl.onmouseup=function(){btnEl.style.transform='scale(1)'};thankYouDiv.appendChild(iconDiv);thankYouDiv.appendChild(titleEl);thankYouDiv.appendChild(messageEl);thankYouDiv.appendChild(btnEl);wrapEl.appendChild(thankYouDiv)}var s=d.currentScript||d.querySelector('script[src*="custom-signup.min.js"]')||null;var src=s&&s.src||'';var base=API_BASE||'';var pub='';try{var us=new URL(src,window.location.origin);pub=us.searchParams.get('pub')||''}catch(_){}form.addEventListener('submit',function(e){e.preventDefault();if(!validate()){for(var j=0;j<inputs.length;j++){if(inputs[j].err.style.display==='block'){try{if(inputs[j].el.length){inputs[j].el[0].focus()}else{inputs[j].el.focus()}}catch(_){}break}}return}btn.disabled=true;var prev=btn.textContent;btn.textContent='Submitting…';var dataObj=collect();var email=getEmail();if(hasFiles()){var fd=new FormData();fd.append('pub',pub);fd.append('email',email);fd.append('data',JSON.stringify(dataObj));appendFiles(fd);fetch(base+'/api/public/signup-requests?pub='+encodeURIComponent(pub),{method:'POST',body:fd}).then(function(res){return res.json().then(function(j){if(!res.ok)throw j;return j})}).then(function(){showThankYouPage()}).catch(function(err){var msg=parseErrorMessage(err);showToast(msg,'error');btn.textContent=prev;btn.disabled=false})}else{var payload={data:dataObj,pub:pub,email:email};fetch(base+'/api/public/signup-requests?pub='+encodeURIComponent(pub),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}).then(function(res){return res.json().then(function(j){if(!res.ok)throw j;return j})}).then(function(){showThankYouPage()}).catch(function(err){var msg=parseErrorMessage(err);showToast(msg,'error');btn.textContent=prev;btn.disabled=false})}});wrap.appendChild(title);wrap.appendChild(subtitle);wrap.appendChild(form);root.appendChild(wrap);if(ly==='split'){page.appendChild(left);}page.appendChild(root);console&&console.log&&console.log('custom-signup: Form created, appending to body');if(!page.parentNode){b.appendChild(page);console&&console.log&&console.log('custom-signup: Page appended to body')}else{console&&console.log&&console.log('custom-signup: Page already in body')}hideAllContent();page.style.display='grid';page.style.visibility='visible';page.style.opacity='1';page.style.width='100%';page.style.height='100vh';console&&console.log&&console.log('custom-signup: Form should be visible now');setTimeout(function(){d.documentElement.style.visibility='visible';d.documentElement.style.opacity='1';if(page){page.style.opacity='1';page.style.visibility='visible';page.style.display='grid';console&&console.log&&console.log('custom-signup: Document made visible')}},50);var observer=new MutationObserver(function(){hideAllContent();var existingContent=d.querySelectorAll('body>*:not(.cs-custom-page):not(#custom-signup-container):not(#custom-signup-loading):not(.cs-toast-container):not(#cs-toast-container)');for(var i=0;i<existingContent.length;i++){if(existingContent[i]!==page&&existingContent[i]!==toastContainer){existingContent[i].style.display='none';existingContent[i].style.visibility='hidden';existingContent[i].style.opacity='0';existingContent[i].style.height='0';existingContent[i].style.overflow='hidden';existingContent[i].style.position='absolute';existingContent[i].style.left='-9999px';existingContent[i].style.pointerEvents='none'}}});if(b){observer.observe(b,{childList:true,subtree:true})}setTimeout(function(){observer.disconnect()},15000)}function run(){if(hasRun)return;var u=window.location;var p=u.pathname;var q=u.search||'';var m=/\\/login\\.php$/i.test(p)&&/(^|[?&])action=create_account(&|$)/i.test(q);console&&console.log&&console.log('custom-signup: URL check',{pathname:p,search:q,matches:m});if(!m){console&&console.log&&console.log('custom-signup: URL does not match, exiting');return}hasRun=true;try{console&&console.log&&console.log('custom-signup: Starting...');hideAllContent();var loadingEl=showLoadingSpinner();var s=document.currentScript||document.querySelector('script[src*="custom-signup.min.js"]')||null;var src=s&&s.src||'';var base=API_BASE||'';var pub='';try{var us=new URL(src,window.location.origin);pub=us.searchParams.get('pub')||''}catch(_){}if(!pub){console&&console.error&&console.error('custom-signup: No pub parameter found in script URL');restoreDefaultForm();return}if(!base){console&&console.error&&console.error('custom-signup: API base URL not configured');restoreDefaultForm();return}var fetchUrl=base+'/api/public/form-config?pub='+encodeURIComponent(pub);console&&console.log&&console.log('custom-signup: Fetching config',{pub:pub,base:base,url:fetchUrl});var fetchOptions={method:'GET',headers:{'Accept':'application/json'}};if(base.includes('ngrok-free.dev')||base.includes('ngrok.io')){fetchOptions.headers['ngrok-skip-browser-warning']='true'}fetch(fetchUrl,fetchOptions).then(function(res){console&&console.log&&console.log('custom-signup: Response received',{status:res.status,statusText:res.statusText,contentType:res.headers.get('content-type'),url:res.url});if(!res.ok){return res.text().then(function(text){var errMsg='Failed to fetch form config: '+res.status+' '+res.statusText;console&&console.error&&console.error('custom-signup: Error response body (full)',text);console&&console.error&&console.error('custom-signup: Error response body (first 1000 chars)',text.substring(0,1000));try{var errorJson=JSON.parse(text);if(errorJson&&errorJson.message){errMsg=errorJson.message}console&&console.error&&console.error('custom-signup: Parsed error JSON',errorJson)}catch(_){}throw new Error(errMsg)})}var contentType=res.headers.get('content-type')||'';if(!contentType.includes('application/json')){return res.text().then(function(text){console&&console.error&&console.error('custom-signup: Non-JSON response (full)',text);console&&console.error&&console.error('custom-signup: Non-JSON response (first 1000 chars)',text.substring(0,1000));throw new Error('Expected JSON response but got '+contentType+'. Server may be returning an error page. URL: '+fetchUrl)})}return res.json()}).then(function(json){console&&console.log&&console.log('custom-signup: Full API response',JSON.stringify(json));if(!json){throw new Error('Empty response from server')}if(json.error===true){throw new Error(json.message||'API returned an error')}if(!json.data){throw new Error('Invalid response format: missing data property. Response: '+JSON.stringify(json).substring(0,500))}var config=json.data;console&&console.log&&console.log('custom-signup: Config received',{fieldsCount:config.fields?config.fields.length:0,config:config});renderForm(config)}).catch(function(err){console&&console.error&&console.error('custom-signup: Error fetching/config rendering',err);restoreDefaultForm();var msg=parseErrorMessage(err);showToast(msg,'error',10000)})}catch(e){hasRun=false;console&&console.error&&console.error('custom-signup error',e);restoreDefaultForm()}}function init(){if(document.body){run()}else{setTimeout(init,10)}}if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',function(){console&&console.log&&console.log('custom-signup: DOMContentLoaded fired');run()},{once:true});window.addEventListener('load',function(){console&&console.log&&console.log('custom-signup: Window load fired');run()},{once:true});setTimeout(function(){console&&console.log&&console.log('custom-signup: Timeout 1 (50ms)');run()},50);setTimeout(function(){console&&console.log&&console.log('custom-signup: Timeout 2 (200ms)');run()},200);setTimeout(function(){console&&console.log&&console.log('custom-signup: Timeout 3 (500ms)');run()},500);setTimeout(function(){console&&console.log&&console.log('custom-signup: Timeout 4 (1000ms)');run()},1000);init()}else{console&&console.log&&console.log('custom-signup: Document already ready, running immediately');run();setTimeout(function(){console&&console.log&&console.log('custom-signup: Delayed run 1');run()},50);setTimeout(function(){console&&console.log&&console.log('custom-signup: Delayed run 2');run()},200)}})();`;
}

async function generateScript() {
  // Get BASE_URL from environment - this is REQUIRED for the script to work
  const baseUrl = (env.BASE_URL || '').replace(/\/+$/, ''); // Remove trailing slashes
  
  if (!baseUrl) {
    throw new Error('BASE_URL environment variable is not set. This is required for the script to fetch form configuration.');
  }
  
  // Validate that BASE_URL is a valid URL
  try {
    new URL(baseUrl);
  } catch {
    throw new Error(`BASE_URL "${baseUrl}" is not a valid URL. Please set BASE_URL to your Next.js app's base URL (e.g., https://your-app.vercel.app)`);
  }
  
  // Warn if using ngrok-free.dev (requires browser interaction)
  if (baseUrl.includes('ngrok-free.dev')) {
    console.warn(`WARNING: BASE_URL uses ngrok-free.dev which requires browser interaction. Consider using a paid ngrok domain or your production URL instead. Current BASE_URL: ${baseUrl}`);
  }
  
  console.log(`Generating script with BASE_URL: ${baseUrl}`);
  
  // Generate generic script (no longer embeds form data)
  // The script will fetch config dynamically using the pub parameter
  const script = generateGenericScript(baseUrl);
  const outPath = path.join(process.cwd(), 'public', 'custom-signup.min.js');
  await writeFile(outPath, script, 'utf8');
  
  return { script, baseUrl };
}

export async function GET() {
  try {
    const { baseUrl } = await generateScript();
    return NextResponse.json({ 
      ok: true, 
      path: '/custom-signup.min.js', 
      baseUrl,
      message: 'Script regenerated successfully with BASE_URL from environment variables'
    });
  } catch (err: any) {
    return NextResponse.json({ ok: false, error: err?.message || 'Unknown error' }, { status: 500 });
  }
}

export async function POST() {
  try {
    const { script, baseUrl } = await generateScript();
    // Return content so callers can store inline in BigCommerce to avoid external dependency
    return NextResponse.json({ ok: true, path: '/custom-signup.min.js', baseUrl, content: script });
  } catch (err: any) {
    return NextResponse.json({ ok: false, error: err?.message || 'Unknown error' }, { status: 500 });
  }
}

